<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>LKMC.KMC &mdash; LKMC 150623-237-g6ff714a documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '150623-237-g6ff714a',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="LKMC 150623-237-g6ff714a documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LKMC 150623-237-g6ff714a documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for LKMC.KMC</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">KMC master script.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Lattice</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Minimise</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Server</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Utilities</span>
<span class="kn">from</span> <span class="nn">.Utilities</span> <span class="k">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Prefactor</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Results</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Search</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Refine</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Defects</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Cascades</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Deposition</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Status</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">ClientServerInterface</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Input</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Basin</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Vectors</span>
<span class="kn">from</span> <span class="nn">.hooks</span> <span class="k">import</span> <span class="n">hook_utils</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Dummy</span>


<span class="c1">################################################################################</span>

<div class="viewcode-block" id="KMCRunner"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner">[docs]</a><span class="k">class</span> <span class="nc">KMCRunner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    KMC runner object.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refState</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thisCascTime</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perfectLattice</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#back up of currentState</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldState</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># hooks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postSelectEventHookList</span> <span class="o">=</span> <span class="n">hook_utils</span><span class="o">.</span><span class="n">makeHookList</span><span class="p">(</span><span class="s2">&quot;postSelectEventHooks&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
    
<div class="viewcode-block" id="KMCRunner.makeVisualiserLink"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.makeVisualiserLink">[docs]</a>    <span class="k">def</span> <span class="nf">makeVisualiserLink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kmcIndex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a link in the Visualiser directory to KMC file with index `kmcIndex`</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># source file</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;KMC&quot;</span><span class="p">,</span> <span class="s2">&quot;KMC</span><span class="si">%d</span><span class="s2">.dat.gz&quot;</span> <span class="o">%</span> <span class="n">kmcIndex</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">))</span>
        
        <span class="c1"># link name</span>
        <span class="n">linkName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">,</span> <span class="s2">&quot;Vis</span><span class="si">%d</span><span class="s2">.dat.gz&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualiserIndex</span><span class="p">)</span>
        
        <span class="c1"># if link name exists, delete it</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lexists</span><span class="p">(</span><span class="n">linkName</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">linkName</span><span class="p">)</span>
        
        <span class="c1"># make the link</span>
        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">linkName</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">visualiserIndex</span> <span class="o">+=</span> <span class="mi">1</span></div>
    
<div class="viewcode-block" id="KMCRunner.run"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputState</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refState</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simulationTime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">KMCStep</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">storeSearchResults</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">server_init</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run KMC.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basinFlag</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">iniMinimised</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">inputState</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">refState</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">inputState</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refState</span> <span class="o">=</span> <span class="n">refState</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">=</span> <span class="n">simulationTime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">=</span> <span class="n">KMCStep</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">jobStatus</span> <span class="o">==</span> <span class="s2">&quot;BEGIN&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refState</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">readLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="s2">&quot;ref.dat&quot;</span><span class="p">))</span>
                
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">depoOn</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">depoAtFirstStep</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
                    <span class="n">depoRunner</span> <span class="o">=</span> <span class="n">Deposition</span><span class="o">.</span><span class="n">DepositionRunner</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
                    <span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">depoRunner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Depo at first step failed...&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">return</span> <span class="mi">55</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">readLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="s2">&quot;launch.dat&quot;</span><span class="p">))</span>
                
                <span class="c1"># set up output dirs</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">server_init</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Server</span><span class="o">.</span><span class="n">LKMCServer</span> <span class="ow">and</span> <span class="n">server_init</span><span class="o">.</span><span class="n">initialised</span><span class="p">):</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Output directory exists: overwriting&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1">#            time.sleep(10)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">)</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;KMC&quot;</span><span class="p">)):</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;KMC&quot;</span><span class="p">))</span>
                    
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">)):</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">))</span>
                    
                    <span class="n">kmcdirs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Step*&quot;</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">kmcdirs</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Defects&quot;</span><span class="p">)):</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Defects&quot;</span><span class="p">))</span>
                
                <span class="c1"># make sure initial lattice is minimised</span>
                <span class="n">minimiser</span> <span class="o">=</span> <span class="n">Minimise</span><span class="o">.</span><span class="n">getMinimiser</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">minimiser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;ERROR: Initial minimisation failed&quot;</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
                <span class="n">iniMinimised</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;KMC&quot;</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">))</span>
                
                <span class="c1"># write initial lattice</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;KMC/KMC0.dat&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">writeLattice</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="c1"># add link in vis dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visualiserIndex</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">makeVisualiserLink</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">params</span><span class="o">.</span><span class="n">jobStatus</span> <span class="o">==</span> <span class="s2">&quot;CNTIN&quot;</span><span class="p">:</span>
                <span class="c1"># make sure the output directory exists</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot coninue a simulation if the output directory does not exist!&quot;</span><span class="p">)</span>
                
                <span class="c1"># read reference lattice</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refState</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">readLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="s2">&quot;ref.dat&quot;</span><span class="p">))</span>
                
                <span class="c1"># visualiser files (for use with the basin method mainly)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">)):</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: continuing simulation with no &#39;Visualiser&#39; directory!&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">visualiserIndex</span> <span class="o">=</span> <span class="mi">0</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">prepareToResume</span><span class="p">()</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: unrecognised jobStatus (BEGIN or CNTIN)&quot;</span><span class="p">)</span>
        
        <span class="n">refState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span>
        
        <span class="c1"># create status object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">LKMCStatusObject</span><span class="p">(</span><span class="s2">&quot;LKMCStatus.html&quot;</span><span class="p">,</span> <span class="s2">&quot;KMC&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">params</span><span class="p">,</span> <span class="n">reuseStats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iniMinimised</span><span class="p">:</span>
            <span class="c1"># minimise initial?</span>
            <span class="n">minimiser</span> <span class="o">=</span> <span class="n">Minimise</span><span class="o">.</span><span class="n">getMinimiser</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">minimiser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;ERROR: Initial minimisation failed&quot;</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
        
        <span class="c1"># set up server</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">server_init</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Server</span><span class="o">.</span><span class="n">LKMCServer</span> <span class="ow">and</span> <span class="n">server_init</span><span class="o">.</span><span class="n">initialised</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server_init</span>
            <span class="n">finaliseServer</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">Server</span><span class="o">.</span><span class="n">LKMCServer</span><span class="p">(</span><span class="n">lkmcParams</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">statusObj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">initiate</span><span class="p">()</span>
            <span class="n">finaliseServer</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># local reference to writer</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">writer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">writer</span>
        
        <span class="c1"># write initial status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">setWriter</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">updateKMCStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">writeStatus</span><span class="p">()</span>
        
        <span class="c1"># if use basin method, print the low barrier criteria</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Activating Basin Method...  Low barrier criteria </span><span class="si">%f</span><span class="s2">, Sub-Low barrier criteria </span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">basinLowBarrier</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">basinLowBarrier</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># read known defect hash keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readDefectVolumes</span><span class="p">()</span>
        
        <span class="c1"># main loop</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># check stop conditions</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">&gt;=</span> <span class="n">params</span><span class="o">.</span><span class="n">KMCMaxSteps</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">KMCMaxTime</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">&gt;=</span> <span class="n">params</span><span class="o">.</span><span class="n">KMCMaxTime</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="c1"># start of new step</span>
            <span class="nb">print</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Starting step </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span>
            
            <span class="c1"># clear searchResults</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="c1"># output directory</span>
            <span class="n">taskOutputDir</span> <span class="o">=</span> <span class="s2">&quot;Step</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,)</span>
            
            <span class="c1"># find / calculate transitions</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="n">taskOutputDir</span><span class="p">)):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="n">taskOutputDir</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="n">taskOutputDir</span><span class="p">))</span>
            
            <span class="c1"># first calculate defects in current lattice</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">wrapAtoms</span><span class="p">()</span> <span class="c1"># probably not the right place to do this but I don&#39;t like sending unwrapped atoms to defects (when using PBCs)</span>
            <span class="n">defectsObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">findDefects</span><span class="p">(</span><span class="n">refState</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">writer</span><span class="p">,</span> 
                    <span class="n">outdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="n">taskOutputDir</span><span class="p">))</span>
            
            <span class="c1"># store a back up for currentState</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oldState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">)</span>
            
            <span class="c1"># if no defects stop?</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">NDefects</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">cascOn</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">perfectLattice</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;System contains no defects, proceeding to next cascade, with a clock adjustment of </span><span class="si">%f</span><span class="s2"> s&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span> <span class="s2">&quot;ERROR: no defects in system: cannot proceed&quot;</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="k">break</span>
            
            <span class="c1"># basin method requires to refine finals</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">refineFinal</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Params ERROR: Basin method requires refine finals as well&quot;</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">44</span>
                <span class="k">break</span>
            
            <span class="c1"># basin method requires to store all transitions found during searches</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">refineSuccessFracForStorage</span> <span class="o">&gt;</span> <span class="mf">0.01</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">refineSavedFracForStorage</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s2">&quot;Params ERROR: Basin method requires store all transitions found during searches. Set refineSuccessFracForStorage and refineSavedFracForStorage to be very small (0).&quot;</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">44</span>
                <span class="k">break</span>
            
            <span class="c1"># render?</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">writePOVDefectsChosen</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">renderPOVDefectsChosen</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;WRITE&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">defectsObj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;Defects&quot;</span><span class="p">)</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;defects</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,),)</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;storePOV&quot;</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">writePOVDefectsChosen</span><span class="p">,</span> 
                          <span class="s2">&quot;renderPOV&quot;</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">renderPOVDefectsChosen</span><span class="p">,</span> 
                          <span class="s2">&quot;renderClusters&quot;</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">renderPOVVolumesChosen</span><span class="p">}</span>
                <span class="n">item</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        
            <span class="c1"># results object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span> <span class="o">=</span> <span class="n">Results</span><span class="o">.</span><span class="n">KMCStepResults</span><span class="p">(</span><span class="n">taskOutputDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">writer</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">statusObj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="p">,</span>
                                                        <span class="n">KMCStep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="n">initialState</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">,</span> <span class="n">refState</span><span class="o">=</span><span class="n">refState</span><span class="p">,</span>
                                                        <span class="n">ratesListLock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">ratesLock</span><span class="p">,</span> <span class="n">ratesListProxy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">ratesListProxy</span><span class="p">)</span>
            <span class="c1"># store old state for future use</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">oldState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldState</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">writeRouletteHeader</span><span class="p">()</span>
            
            <span class="c1"># transition searches</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTransitions</span><span class="p">()</span>
            
            <span class="c1"># error?</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;ERROR: getTransitions exited with status&quot;</span><span class="p">,</span> <span class="n">status</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">9</span>
                <span class="k">break</span>

            <span class="c1"># Add external event to roulette list</span>
            <span class="c1"># Cascades</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">cascOn</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">addEventRateToDict</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">cascRate</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">eventIndex</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">writeRouletteEvent</span><span class="p">(</span><span class="n">eventIndex</span><span class="p">)</span>
            <span class="c1"># Depositions</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">depoOn</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">addEventRateToDict</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">depoRate</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">eventIndex</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">writeRouletteEvent</span><span class="p">(</span><span class="n">eventIndex</span><span class="p">)</span>
                
            <span class="c1"># choose an event</span>
            <span class="c1"># if basin method, save results and update rates</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">useBasin</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">numList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinFlag</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">saveResults2Basin</span><span class="p">()</span>
                    <span class="n">status</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verifyBasin</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">saveResults2Basin</span><span class="p">(</span><span class="n">retry</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="s2">&quot;ERROR in verify Basin, Cannot fix linkage of existing basins.&quot;</span><span class="p">,</span> <span class="n">info</span>
                        <span class="k">break</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">updateRates</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="s2">&quot;ERROR in mean rate calculation&quot;</span>
                        <span class="k">break</span>
                    
                    <span class="c1"># re-write roulette</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">writeRouletteHeaderBasin</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">])):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">writeRouletteEvent</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">verboseLevel</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;PRE-SELECT DEBUG: basinList#:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                    <span class="nb">print</span> <span class="s2">&quot;*&quot;</span><span class="o">*</span><span class="mi">30</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">printout</span><span class="p">()</span>
            
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                    <span class="n">basinI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;In basin # </span><span class="si">%d</span><span class="s2"> : </span><span class="si">%d</span><span class="s2"> volumes&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="c1"># stop if no event found</span>
            <span class="c1"># need to generalise for external events</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;ERROR: no events found: cannot proceed&quot;</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">break</span>
            
            <span class="n">eventTime</span><span class="p">,</span> <span class="n">chosenIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectEvent</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="n">chosenIndex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># already use basin method</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinFlag</span><span class="p">:</span>
                    <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">belong2Basin</span><span class="p">(</span><span class="n">chosenIndex</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;DEBUG: chosenIndex </span><span class="si">%d</span><span class="s2">, basinNum </span><span class="si">%s</span><span class="s2">, volumeNum </span><span class="si">%s</span><span class="s2">, transNum </span><span class="si">%s</span><span class="s2">, barrier </span><span class="si">%f</span><span class="s2">, flag </span><span class="si">%s</span><span class="s2">,&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">chosenIndex</span><span class="p">,</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentTrans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">],</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;DEBUG: chosenIndex </span><span class="si">%d</span><span class="s2">, basinNum </span><span class="si">%s</span><span class="s2">, volumeNum </span><span class="si">%s</span><span class="s2">, transNum None, barrier </span><span class="si">%f</span><span class="s2">, flag </span><span class="si">%s</span><span class="s2">,&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">chosenIndex</span><span class="p">,</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="c1"># select an ordinary event</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># if this event belongs to an existing basin, exit this basin</span>
                        <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">basinNum</span><span class="p">)</span>
                            <span class="c1"># if there is no existing basin, quit basin method</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">basinFlag</span> <span class="o">=</span> <span class="mi">0</span>
                        
                        <span class="c1"># if this event not belongs to any existing basin</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">pass</span>
                        
                    <span class="c1"># if select deposition, exit basin</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">basinFlag</span> <span class="o">=</span> <span class="mi">0</span>
                    
                    <span class="c1"># select a low barrier event</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># if volume number changes, exit basin</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Selected transition&#39;s final&#39;s number of DV different from initial&#39;s.&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">basinNum</span><span class="p">)</span>
                                <span class="c1"># if there is no existing basin, quit basin method</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">basinFlag</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">storeBasinResult</span><span class="p">(</span><span class="n">chosenIndex</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">basinFlag</span> <span class="o">=</span> <span class="mi">1</span>
                
                <span class="c1"># not using basin method on last KMC step</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;DEBUG: chosenIndex </span><span class="si">%d</span><span class="s2">, flag: </span><span class="si">%s</span><span class="s2">, barrier </span><span class="si">%f</span><span class="s2">, reverseBarrier </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">chosenIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">],</span>
                                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">],</span>
                                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reverseBarriers&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">numList</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># select a low barrier event</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Selected transition&#39;s final&#39;s number of DV different from initial&#39;s.&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                        <span class="c1">#start basin method</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">basinFlag</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">storeBasinResult</span><span class="p">(</span><span class="n">chosenIndex</span><span class="p">)</span>
                <span class="c1"># write out basin file</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">):</span>
                    <span class="n">Basin</span><span class="o">.</span><span class="n">writeBasin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">verboseLevel</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;POST-SELECT DEBUG: basinList#:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                    <span class="nb">print</span> <span class="s2">&quot;*&quot;</span><span class="o">*</span><span class="mi">30</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">printout</span><span class="p">()</span>
            
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                    <span class="n">basinI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;In basin # </span><span class="si">%d</span><span class="s2"> : </span><span class="si">%d</span><span class="s2"> volumes&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    
            <span class="k">if</span> <span class="n">eventTime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="k">break</span>
            
            <span class="c1"># run any post choose event hooks</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postSelectEventHookList</span><span class="p">):</span>
                <span class="nb">print</span> <span class="s2">&quot;RUNNING POST SELECT HOOKS&quot;</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;currentState&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">,</span> 
                          <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                          <span class="s2">&quot;refState&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">}</span>
                
                <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">postSelectEventHookList</span><span class="p">:</span>
                    <span class="n">hook</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
            <span class="c1"># Clock adjustment for perfect lattices</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perfectLattice</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cascDuration</span><span class="o">*</span><span class="mi">1</span><span class="n">E</span><span class="o">-</span><span class="mi">15</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">eventTime</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Attention: KMC simulated time since last cascade, </span><span class="si">%.15f</span><span class="s2">, is greater than eventTime </span><span class="si">%.15f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cascDuration</span><span class="o">*</span><span class="mi">1</span><span class="n">E</span><span class="o">-</span><span class="mi">15</span><span class="p">),</span> <span class="n">eventTime</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;To avoid time travel (i.e. non-linear clock progression), we are increasing eventTime to match the simulated time since last the last cascade.&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">eventTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cascDuration</span><span class="o">*</span><span class="mi">1</span><span class="n">E</span><span class="o">-</span><span class="mi">15</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;eventTime is now set to </span><span class="si">%.15f</span><span class="s2"> s.&quot;</span><span class="o">%</span><span class="n">eventTime</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cascDuration</span><span class="o">*</span><span class="mi">1</span><span class="n">E</span><span class="o">-</span><span class="mi">15</span>

            <span class="c1"># Time Incrementation</span>
            <span class="c1"># If we&#39;re not using cascade events in this simulation, advance the clock as normal.</span>
            <span class="c1"># If the lattice has defects, and we are using cascades, advance the clock as normal.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">cascOn</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">perfectLattice</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">+=</span> <span class="n">eventTime</span>
            <span class="c1"># If the lattice has no defects, but we&#39;re on step 0, we do not want to add any KMC step time to the clock.</span>
            <span class="c1"># If we&#39;re not on step 0, advance the clock as normal.</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">perfectLattice</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;At the beginging of this step (Step </span><span class="si">%d</span><span class="s2">), the system had healed from a previous cascade, thus a new event was introduced.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;As such, we are advancing the clock by the event time, </span><span class="si">%.15f</span><span class="s2"> s, in relation to the previous cascade, which occurred at </span><span class="si">%.15f</span><span class="s2"> s&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">eventTime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">+=</span> <span class="n">eventTime</span>
            <span class="c1"># Update lastCascTime with most recent event &amp; reset perfectLattice flag.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thisCascTime</span>
            <span class="c1"># Un-flag perfectLattice</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">perfectLattice</span> <span class="o">=</span> <span class="kc">False</span>
                        
            <span class="c1"># write roulette file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">writeRouletteFooter</span><span class="p">(</span><span class="n">chosenIndex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span><span class="p">)</span>
            
            <span class="c1"># write selected final</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">writeSelectedFinal</span><span class="p">(</span><span class="n">chosenIndex</span><span class="p">,</span> <span class="s2">&quot;KMC/KMC</span><span class="si">%d</span><span class="s2">.dat&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,),</span> <span class="n">latticeIn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">)</span>
            
            <span class="c1"># visualiser file</span>
            <span class="n">isBasinEvent</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">chosenIndex</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isBasinEvent</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">makeVisualiserLink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;End of step </span><span class="si">%d</span><span class="s2">. Simulation time is </span><span class="si">%.15g</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1"># update status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">updateKMCStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">resetSearches</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">writeStatus</span><span class="p">()</span>
            
            <span class="c1"># Check writer process is still alive; cannot proceed if not</span>
            <span class="n">writerStatus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">checkAlive</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">writerStatus</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Error: Writer process has died (</span><span class="si">%d</span><span class="s2">); cannot continue&quot;</span> <span class="o">%</span> <span class="n">writerStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="k">break</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">storeSearchResults</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">finaliseServer</span><span class="p">:</span>
            <span class="c1"># shutdown server</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">finalise</span><span class="p">()</span>
        
        <span class="c1"># flush STDOUT</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: terminated due to no events found&quot;</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: terminated due to no defects found&quot;</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: terminated due to selectEvent failure&quot;</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">44</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Params ERROR: Basin method requires refine finals, as well as store all transitions&quot;</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: terminated due Writer dying&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Simulation finished&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="n">status</span></div>
    
<div class="viewcode-block" id="KMCRunner.getLastCascTime"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.getLastCascTime">[docs]</a>    <span class="k">def</span> <span class="nf">getLastCascTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the time of the last cascade event from cascAttributes.out.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timeDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;lastCascTime.OUT&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">timeDir</span><span class="p">):</span>
            <span class="n">lastCascTimeFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">timeDir</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lastCascTimeFile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="KMCRunner.prepareToResume"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.prepareToResume">[docs]</a>    <span class="k">def</span> <span class="nf">prepareToResume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare to resume KMC simulation.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        
        <span class="c1"># for now we just read in the latest stored KMC lattice</span>
        <span class="c1"># and start the step corresponding to that</span>
        <span class="n">KMCLatticeDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;KMC&quot;</span><span class="p">)</span>
        
        <span class="c1"># find KMC lattice file to resume from</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">KMCLatticeDir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># find latest KMC file</span>
            <span class="n">lastKMCFile</span><span class="p">,</span> <span class="n">lastKMCFileIndex</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">findLastKMCLattice</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">KMCLookFrom</span><span class="p">)</span>
            
            <span class="c1"># check integrity</span>
            <span class="n">fileIntegrity</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">checkLatticeFileIntegrity</span><span class="p">(</span><span class="n">lastKMCFile</span><span class="p">)</span>
            
            <span class="k">while</span> <span class="ow">not</span> <span class="n">fileIntegrity</span><span class="p">:</span>
                <span class="n">lastKMCFileIndex</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">lastKMCFileIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: prepareToResume: backtracked too far&quot;</span><span class="p">)</span>
                
                <span class="n">lastKMCFile</span> <span class="o">=</span> <span class="s2">&quot;KMC</span><span class="si">%d</span><span class="s2">.dat&quot;</span> <span class="o">%</span> <span class="n">lastKMCFileIndex</span>
                <span class="n">fileIntegrity</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">checkLatticeFileIntegrity</span><span class="p">(</span><span class="n">lastKMCFile</span><span class="p">)</span>
            
            
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Resuming with KMC file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">lastKMCFile</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span> <span class="o">=</span> <span class="n">lastKMCFileIndex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">Lattice</span><span class="o">.</span><span class="n">readLattice</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;KMC&quot;</span><span class="p">,</span> <span class="n">lastKMCFile</span><span class="p">))</span>
        
        <span class="c1"># Retrieve the time of the last cascade, if appropriate.</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">cascOn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getLastCascTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Retrieving time of last cascade: </span><span class="si">%.15f</span><span class="s2"> s.&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">lastCascTime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># find visualiser file associated with last KMC file</span>
        <span class="n">kmcVisDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Visualiser&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">kmcVisDir</span><span class="p">):</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Attempting to locate last visualiser file (last KMC file index is </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">lastKMCFileIndex</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">kmcVisDir</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># look for vis file that links to chosen kmc file</span>
                <span class="c1"># note we do not check if the links are valid</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">vfn</span> <span class="o">=</span> <span class="s2">&quot;Vis</span><span class="si">%d</span><span class="s2">.dat.gz&quot;</span> <span class="o">%</span> <span class="n">count</span>
                <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">vfn</span><span class="p">):</span>
                    <span class="n">linkedFn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">vfn</span><span class="p">))</span>
                    <span class="n">linkedIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">linkedFn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">:])</span>
                    <span class="k">if</span> <span class="n">linkedIndex</span> <span class="o">&gt;</span> <span class="n">lastKMCFileIndex</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">vfn</span> <span class="o">=</span> <span class="s2">&quot;Vis</span><span class="si">%d</span><span class="s2">.dat.gz&quot;</span> <span class="o">%</span> <span class="n">count</span>
                
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Found next visualiser index: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">count</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visualiserIndex</span> <span class="o">=</span> <span class="n">count</span>
            
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">kmcVisDir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visualiserIndex</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># read current simulation time from relevant roulette file</span>
        <span class="n">rouletteStepIndex</span> <span class="o">=</span> <span class="n">lastKMCFileIndex</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">rouletteStepIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Step</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rouletteStepIndex</span><span class="p">,),</span> <span class="s2">&quot;Roulette.OUT&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">gotTime</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Simulation time&quot;</span><span class="p">):</span>
                        <span class="n">array</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                        <span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">gotTime</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">gotTime</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: prepareToResume: resume screwed up trying to retrieve time&quot;</span><span class="p">)</span>
        
        <span class="c1"># read stored basin</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">basinReset</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,</span> <span class="s2">&quot;Step</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rouletteStepIndex</span><span class="p">,),</span> <span class="s2">&quot;basinList.bsn&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">checkForFile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Reading saved basin list from: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">filename</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">Basin</span><span class="o">.</span><span class="n">readBasin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">basinFlag</span> <span class="o">=</span> <span class="mi">1</span>
                
                <span class="c1"># print resume basin info</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">verboseLevel</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">printout</span><span class="p">()</span>
                
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                        <span class="n">basinI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;In basin # </span><span class="si">%d</span><span class="s2"> : </span><span class="si">%d</span><span class="s2"> volumes&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span></div>
        
    
<div class="viewcode-block" id="KMCRunner.selectEvent"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.selectEvent">[docs]</a>    <span class="k">def</span> <span class="nf">selectEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select event from results.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        <span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span>
        <span class="n">defectVolumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        
        <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">attempts2</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># number of deposition attempts</span>
        <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">resultsLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">])</span>
        
        <span class="k">while</span> <span class="n">xContinue</span> <span class="ow">and</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="n">resultsLen</span> <span class="ow">and</span> <span class="n">attempts2</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># random number between 0 and totalRate</span>
            <span class="n">randnum</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="n">results</span><span class="o">.</span><span class="n">totalRate</span>
            
            <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">totalRate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            
<span class="c1">#            # Debug the rate thing!!!</span>
<span class="c1">#            rates = results.resultsDict[&quot;rates&quot;]</span>
<span class="c1">#            print &quot;DEBUG EVENT SELECT:\n    TOTAL RATE: &quot;,results.totalRate,&quot;\n    %d RATES: &quot;%len(rates),</span>
<span class="c1">#            for i in xrange(len(rates)):</span>
<span class="c1">#                print rates[i], &quot; &quot;,</span>
<span class="c1">#            print &quot;\n    RANDOM NUMBER: &quot;,randnum</span>
            
            <span class="c1"># now sum rates until exceed randnum</span>
            <span class="n">ratesum</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rates</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rates</span><span class="p">)):</span>
                <span class="n">ratesum</span> <span class="o">+=</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">ratesum</span> <span class="o">&gt;</span> <span class="n">randnum</span><span class="p">:</span>
                    <span class="k">break</span>
            
            <span class="c1"># time associated with event</span>
            <span class="n">randnum</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
            <span class="n">eventTime</span> <span class="o">=</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">randnum</span><span class="p">)</span> <span class="o">/</span> <span class="n">results</span><span class="o">.</span><span class="n">totalRate</span>
            
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Selected event </span><span class="si">%d</span><span class="s2">: rate </span><span class="si">%g</span><span class="s2">; barrier </span><span class="si">%g</span><span class="s2"> eV; event time </span><span class="si">%g</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">eventTime</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">newInputState</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finals&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">True</span>
                
            <span class="k">elif</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finals&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">originInfo</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reuseInfo&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">workingVol</span><span class="p">,</span> <span class="n">originHashKey</span><span class="p">,</span> <span class="n">originTransNo</span> <span class="o">=</span> <span class="n">originInfo</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
                    
                    <span class="n">workingVol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">workingVol</span><span class="p">)</span>
                    <span class="n">originTransNo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">originTransNo</span><span class="p">)</span>
                    
                    <span class="nb">print</span> <span class="s2">&quot;REUSING FINAL STATE OF SELECTED EVENT&quot;</span><span class="p">,</span> <span class="n">workingVol</span><span class="p">,</span> <span class="n">originHashKey</span><span class="p">,</span> <span class="n">originTransNo</span>
                    
<span class="c1">#                    volfile = os.path.join(params.volumeDirectory, </span>
<span class="c1">#                        &quot;%s.vol&quot; % originHashKey)</span>
                    
                    <span class="n">graphVolume</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">workingVol</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span>
                    
<span class="c1">#                     print &quot;VOLUME FILE %s&quot; % (volfile)</span>
                    
                    <span class="nb">print</span> <span class="n">originHashKey</span><span class="p">,</span> <span class="n">graphVolume</span>
                    
<span class="c1">#                     transitions = readVolumeTransitionsFile(volfile, currentState, graphVolume, </span>
<span class="c1">#                         hashKey=graphVolume)</span>
                    
<span class="c1">#                     currentState.currentGraphVolume = currentState.graphVols[workingVol]</span>
                    <span class="n">currentState</span><span class="o">.</span><span class="n">currentDefectVolume</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">workingVol</span><span class="p">]</span>
                    
<span class="c1">#                     transIniPos = transitions[0]</span>
<span class="c1">#                     transSpecie = transitions[1]</span>
<span class="c1">#                     transList = transitions[2]</span>
                    
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">transitions</span> <span class="o">=</span> <span class="n">defectVolumes</span><span class="p">[</span><span class="n">originHashKey</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;ERROR: Volume transitions </span><span class="si">%s</span><span class="s2"> not found. &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">originHashKey</span><span class="p">,),</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                    
                    <span class="n">transIniPos</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">initialPos</span>
                    <span class="n">transSpecie</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">specie</span>
                    <span class="n">transList</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">transitionList</span>
                    
                    <span class="n">transitionRefiner</span> <span class="o">=</span> <span class="n">Refine</span><span class="o">.</span><span class="n">TransitionRefiner</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
                    <span class="n">transitionRefiner</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">currentState</span><span class="p">)</span>
                    
                    <span class="n">trans</span> <span class="o">=</span> <span class="n">transList</span><span class="p">[</span><span class="n">originTransNo</span><span class="p">]</span>
                    
                    <span class="n">newInputState</span><span class="p">,</span> <span class="n">resultInfo</span> <span class="o">=</span> <span class="n">transitionRefiner</span><span class="o">.</span><span class="n">refineFinalState</span><span class="p">(</span><span class="n">transIniPos</span><span class="p">,</span> <span class="n">transSpecie</span><span class="p">,</span> <span class="n">graphVolume</span><span class="p">,</span> <span class="n">volumeTransitionObject</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">newInputState</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">totalRate</span> <span class="o">-=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">True</span>
                    
                    <span class="c1">#print newInputState, resultInfo</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">newInputState</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finals&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    
            <span class="c1"># if external event, do deposition/cascade</span>
            <span class="k">elif</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">currentState_backup</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">3.1</span><span class="p">:</span>
                    <span class="c1"># Make note of time at which this cascade begins.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thisCascTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span>
                    <span class="c1"># Create cascade object</span>
                    <span class="n">cascRunner</span> <span class="o">=</span> <span class="n">Cascades</span><span class="o">.</span><span class="n">CascadeRunner</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
                    <span class="c1"># Run cascade</span>
                    <span class="n">statusEvent</span><span class="p">,</span> <span class="n">newInputState</span> <span class="o">=</span> <span class="n">cascRunner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">,</span> <span class="n">clock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">simulationTime</span><span class="p">)</span>
                
                <span class="k">elif</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">3.2</span><span class="p">:</span>
                    <span class="n">depoRunner</span> <span class="o">=</span> <span class="n">Deposition</span><span class="o">.</span><span class="n">DepositionRunner</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
                    <span class="n">statusEvent</span><span class="p">,</span> <span class="n">newInputState</span> <span class="o">=</span> <span class="n">depoRunner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">)</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unknown barrierOrigin for external event&quot;</span><span class="p">)</span>
                
                <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="k">if</span> <span class="n">statusEvent</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">3.1</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Cascade event failed!&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">3.2</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Deposition event failed!&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">attempts</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">attempts2</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Restoring pre-event state&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">currentState_backup</span><span class="p">)</span>
                
            <span class="c1"># if select an basin event</span>
            <span class="k">elif</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">belong2Basin</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">volumeNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dupFlag</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Selected event from a duplicate basin state, can&#39;t refine.&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">DVbackup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span>
                        <span class="n">currentState_backup</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">)</span>
                        <span class="n">status</span><span class="p">,</span> <span class="n">currentState2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">performTransition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
                
                <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;transIndex&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Error! Cannot reuse current basin event, try to reselect...&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                    
                    <span class="n">workingVol</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">originHashKey</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">originTransNo</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;transIndex&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    
                    <span class="c1"># check validness of vorkingVol.</span>
                    <span class="k">if</span> <span class="n">workingVol</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">):</span>
                        <span class="n">workingVol</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">elif</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">workingVol</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span> <span class="o">!=</span> <span class="n">originHashKey</span><span class="p">:</span>
                        <span class="n">workingVol</span> <span class="o">=</span> <span class="kc">None</span>
                        
                    <span class="c1"># try to find the right workingVol</span>
                    <span class="k">if</span> <span class="n">workingVol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">tmpList</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span> <span class="o">==</span> <span class="n">originHashKey</span><span class="p">:</span>
                                <span class="n">tmpList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmpList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmpList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">workingVol</span> <span class="o">=</span> <span class="n">tmpList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">elif</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeCOM&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">tmpList2</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">tmpList</span><span class="p">:</span>
                                    <span class="n">tmpList2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeCOM&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">cellDims</span><span class="p">))</span>
                                <span class="n">workingVol</span> <span class="o">=</span> <span class="n">tmpList</span><span class="p">[</span><span class="n">tmpList2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tmpList2</span><span class="p">))]</span>
                    
                    <span class="k">if</span> <span class="n">workingVol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        
                        <span class="c1"># store selected transition&#39;s index</span>
                        <span class="n">volumeij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeNum</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volumeij</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
                            <span class="n">transijk</span> <span class="o">=</span> <span class="n">volumeij</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">transijk</span><span class="o">.</span><span class="n">finalAtomPos</span> <span class="o">==</span> <span class="n">originTransNo</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentTrans</span> <span class="o">=</span> <span class="n">pp</span>
                                <span class="k">break</span>
                        
                        <span class="nb">print</span> <span class="s2">&quot;REUSING FINAL STATE OF SELECTED EVENT&quot;</span><span class="p">,</span> <span class="n">workingVol</span><span class="p">,</span> <span class="n">originHashKey</span><span class="p">,</span> <span class="n">originTransNo</span><span class="p">,</span>
                        <span class="nb">print</span> <span class="s2">&quot;Basin </span><span class="si">%d</span><span class="s2"> Volume </span><span class="si">%d</span><span class="s2"> Trans </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentTrans</span><span class="p">)</span>
                        
                        <span class="n">graphVolume</span> <span class="o">=</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">workingVol</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span>
                        
                        <span class="n">currentState2</span><span class="o">.</span><span class="n">currentDefectVolume</span> <span class="o">=</span> <span class="n">currentState2</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">workingVol</span><span class="p">]</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">transitions</span> <span class="o">=</span> <span class="n">defectVolumes</span><span class="p">[</span><span class="n">originHashKey</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;ERROR: Volume transitions </span><span class="si">%s</span><span class="s2"> not found. &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">originHashKey</span><span class="p">,),</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">currentState_backup</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">=</span> <span class="n">DVbackup</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentTrans</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                        
                        <span class="n">transIniPos</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">initialPos</span>
                        <span class="n">transSpecie</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">specie</span>
                        <span class="n">transList</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">transitionList</span>
                        
                        <span class="n">transitionRefiner</span> <span class="o">=</span> <span class="n">Refine</span><span class="o">.</span><span class="n">TransitionRefiner</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
                        <span class="n">transitionRefiner</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">currentState2</span><span class="p">)</span>
                        
                        <span class="n">trans</span> <span class="o">=</span> <span class="n">transList</span><span class="p">[</span><span class="n">originTransNo</span><span class="p">]</span>
                        
                        <span class="n">newInputState</span><span class="p">,</span> <span class="n">resultInfo</span> <span class="o">=</span> <span class="n">transitionRefiner</span><span class="o">.</span><span class="n">refineFinalState</span><span class="p">(</span><span class="n">transIniPos</span><span class="p">,</span> <span class="n">transSpecie</span><span class="p">,</span> <span class="n">graphVolume</span><span class="p">,</span> <span class="n">volumeTransitionObject</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">newInputState</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">currentState_backup</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">=</span> <span class="n">DVbackup</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentTrans</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">totalRate</span> <span class="o">-=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">currentState_backup</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">=</span> <span class="n">DVbackup</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentTrans</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">totalRate</span> <span class="o">-=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xSuccess</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">xContinue</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">currentState_backup</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">=</span> <span class="n">DVbackup</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">currentTrans</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">totalRate</span> <span class="o">-=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;ERROR: Selected an event with unknown origin&quot;</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">xSuccess</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span> <span class="o">=</span> <span class="n">newInputState</span>
            <span class="k">return</span> <span class="n">eventTime</span><span class="p">,</span> <span class="n">i</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;Cannot select an event...&quot;</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>
    
<div class="viewcode-block" id="KMCRunner.addSearches"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.addSearches">[docs]</a>    <span class="k">def</span> <span class="nf">addSearches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volumeIndex</span><span class="p">,</span> <span class="n">storeTransIfSearching</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">,</span> <span class="n">fixSearchDict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">volTransObject</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add searches on volume.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># local refs</span>
        <span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        
        <span class="c1"># defect volume</span>
        <span class="n">dv</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span>
        
        <span class="c1"># store transitions for reuse</span>
        <span class="k">if</span> <span class="n">dv</span><span class="o">.</span><span class="n">combinedVol</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">reuseCombinedVolumes</span><span class="p">:</span>
            <span class="n">storeForReuse</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">elif</span> <span class="n">dv</span><span class="o">.</span><span class="n">partOfCombinedVol</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">combinedVolStoreIndividual</span><span class="p">:</span>
            <span class="n">storeForReuse</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">elif</span> <span class="n">dv</span><span class="o">.</span><span class="n">combinedVol</span> <span class="ow">or</span> <span class="n">dv</span><span class="o">.</span><span class="n">partOfCombinedVol</span><span class="p">:</span>
            <span class="n">storeForReuse</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">storeForReuse</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="n">volTransObject</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">append</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">if</span> <span class="n">storeForReuse</span><span class="p">:</span>
                <span class="c1"># transitions object</span>
                <span class="n">volTransObject</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">VolumeTransitionsObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                <span class="n">volTransObject</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">graphVol</span><span class="p">,</span> <span class="n">currentState</span><span class="p">,</span> <span class="n">dv</span><span class="o">.</span><span class="n">graphKey</span><span class="p">)</span>
                
                <span class="n">transObjDict</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">volTransObject</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">volTransObject</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">append</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># are we fixing search input</span>
        <span class="k">if</span> <span class="n">fixSearchDict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fixList</span> <span class="o">=</span> <span class="n">fixSearchDict</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span>
        
        <span class="c1"># number of searches</span>
        <span class="n">NSearches</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">kmcNoSearch</span>
        
        <span class="c1"># check fix list</span>
        <span class="n">extraJobsPerc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">extraJobs</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extraJobsPerc</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">extraJobsPerc</span> <span class="o">=</span> <span class="mf">1.0</span>
        
        <span class="n">NSearchesToAdd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">extraJobsPerc</span><span class="p">)</span> <span class="o">*</span> <span class="n">NSearches</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">fixSearchDict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixList</span><span class="p">)</span> <span class="o">==</span> <span class="n">NSearchesToAdd</span><span class="p">,</span> <span class="s2">&quot;ERROR: fixList wrong length </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fixList</span><span class="p">),</span> <span class="n">NSearchesToAdd</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">dv</span><span class="o">.</span><span class="n">combinedVol</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Adding searches on combined volume </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> atoms, </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">) searches)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> 
                                                                                                  <span class="nb">len</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">),</span> 
                                                                                                  <span class="n">NSearches</span><span class="p">,</span> <span class="n">NSearchesToAdd</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Adding searches on volume </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> atoms, </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">) searches)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> 
                                                                                         <span class="nb">len</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">searchInitialVol</span><span class="p">),</span> 
                                                                                         <span class="n">NSearches</span><span class="p">,</span> 
                                                                                         <span class="n">NSearchesToAdd</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># unique id for this job</span>
        <span class="n">jobID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span>        
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;JobID: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">jobID</span><span class="p">),),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># tell results about this volume</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">modifyVolumeNItems</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">NSearches</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">addVolume</span><span class="p">(</span><span class="n">jobID</span><span class="p">,</span> <span class="n">volumeIndex</span><span class="p">,</span> <span class="n">NSearches</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">volTransObject</span><span class="o">=</span><span class="n">volTransObject</span><span class="p">)</span>
        
        <span class="c1"># update status obj</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="n">statusNumSearches</span> <span class="o">=</span> <span class="n">NSearches</span> <span class="o">*</span> <span class="mf">2.0</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">statusNumSearches</span> <span class="o">=</span> <span class="n">NSearches</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">updateSearchInfo</span><span class="p">(</span><span class="n">NSearches</span><span class="o">=</span><span class="p">{</span><span class="n">volumeIndex</span><span class="p">:</span> <span class="n">statusNumSearches</span><span class="p">,})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">writeStatus</span><span class="p">()</span>
        
        <span class="c1"># searcher</span>
        <span class="n">searcher</span> <span class="o">=</span> <span class="n">Search</span><span class="o">.</span><span class="n">TransitionSearcher</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">storeTransForReuse</span><span class="o">=</span><span class="n">storeForReuse</span><span class="p">)</span>
        <span class="n">searcher</span><span class="o">.</span><span class="n">setJobID</span><span class="p">(</span><span class="n">jobID</span><span class="p">)</span>
        <span class="n">searcher</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        
        <span class="c1"># current data ID</span>
        <span class="n">currentDataID</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">currentDataID</span>
        
        <span class="k">if</span> <span class="n">fixSearchDict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># job</span>
            <span class="n">jobItem</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">JobQueueItem</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">jobID</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">searcher</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,),</span> <span class="n">dataID</span><span class="o">=</span><span class="n">currentDataID</span><span class="p">)</span>
            
            <span class="c1"># add jobs</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">NSearchesToAdd</span><span class="p">):</span>
                <span class="n">server</span><span class="o">.</span><span class="n">addJob</span><span class="p">(</span><span class="n">jobItem</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># add jobs</span>
            <span class="k">for</span> <span class="n">fixObj</span> <span class="ow">in</span> <span class="n">fixList</span><span class="p">:</span>
                <span class="c1"># fix object passed as kwarg</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fixSearchObj&quot;</span><span class="p">:</span> <span class="n">fixObj</span><span class="p">}</span>
                
                <span class="c1"># job item</span>
                <span class="n">jobItem</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">JobQueueItem</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">jobID</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">searcher</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> 
                                                             <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,),</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">dataID</span><span class="o">=</span><span class="n">currentDataID</span><span class="p">)</span>
                
                <span class="c1"># add job</span>
                <span class="n">server</span><span class="o">.</span><span class="n">addJob</span><span class="p">(</span><span class="n">jobItem</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="KMCRunner.addIniEigenValCalcs"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.addIniEigenValCalcs">[docs]</a>    <span class="k">def</span> <span class="nf">addIniEigenValCalcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobID</span><span class="p">,</span> <span class="n">iniEVList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add initial eigenvalue calculations on volumes</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># local refs</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span>
        <span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
                
        <span class="n">NItems</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iniEVList</span><span class="p">)</span>
        
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Adding initial eigenvalue calculations on volumes: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NItems</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">Prefactor</span><span class="o">.</span><span class="n">PrefactorCalculator</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        
        <span class="c1"># current data ID</span>
        <span class="n">currentDataID</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">currentDataID</span>
        
        <span class="n">results</span><span class="o">.</span><span class="n">addIniEigenValCalcs</span><span class="p">(</span><span class="n">jobID</span><span class="p">,</span> <span class="n">iniEVList</span><span class="p">)</span>
        
        <span class="c1"># add to queue</span>
        <span class="k">for</span> <span class="n">volumeIndex</span> <span class="ow">in</span> <span class="n">iniEVList</span><span class="p">:</span>
            <span class="n">jobItem</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">JobQueueItem</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">jobID</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">calculator</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;calculate&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="p">),</span> <span class="n">dataID</span><span class="o">=</span><span class="n">currentDataID</span><span class="p">)</span>
            
            <span class="n">server</span><span class="o">.</span><span class="n">addJob</span><span class="p">(</span><span class="n">jobItem</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="KMCRunner.addRefinement"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.addRefinement">[docs]</a>    <span class="k">def</span> <span class="nf">addRefinement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volumeIndex</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add refinement on volume.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># local refs</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span>
        <span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        
        <span class="c1"># graph volume</span>
        <span class="n">graphVolume</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span>
        <span class="n">graphKey</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span>
        
        <span class="c1"># get transitions</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">transitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>
            
            <span class="n">transObjDict</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">transitions</span>
        
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: volume does not exist in reuse dict (</span><span class="si">%s</span><span class="s2">): we should search but I haven&#39;t implemented it yet&quot;</span> <span class="o">%</span> <span class="n">graphKey</span>
            <span class="k">return</span> <span class="mi">1</span>
        
        <span class="n">NItems</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">transitions</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span>
        
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Adding refinement on volume </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> atoms, </span><span class="si">%d</span><span class="s2"> transitions)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">graphVolume</span><span class="p">),</span> <span class="n">NItems</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># unique id for this job</span>
        <span class="n">jobID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;JobID: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">jobID</span><span class="p">),),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># tell results about this volume</span>
        <span class="n">results</span><span class="o">.</span><span class="n">addVolume</span><span class="p">(</span><span class="n">jobID</span><span class="p">,</span> <span class="n">volumeIndex</span><span class="p">,</span> <span class="n">NItems</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">volTransObject</span><span class="o">=</span><span class="n">transitions</span><span class="p">)</span>
        
        <span class="c1"># if empty job, set to finished</span>
        <span class="k">if</span> <span class="n">NItems</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">finished</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1"># update status obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">updateSearchInfo</span><span class="p">(</span><span class="n">NSearches</span><span class="o">=</span><span class="p">{</span><span class="n">volumeIndex</span><span class="p">:</span> <span class="n">NItems</span><span class="p">,})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">writeStatus</span><span class="p">()</span>
        
        <span class="n">transIniPos</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">initialPos</span>
        <span class="n">transSpecie</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">specie</span>
        <span class="n">transList</span> <span class="o">=</span> <span class="n">transitions</span><span class="o">.</span><span class="n">transitionList</span>
        
        <span class="k">if</span> <span class="n">transIniPos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;ERROR: transIniPos is None&quot;</span>
            <span class="k">return</span> <span class="mi">2</span>
        
        <span class="c1"># refiner object</span>
        <span class="n">refiner</span> <span class="o">=</span> <span class="n">Refine</span><span class="o">.</span><span class="n">TransitionRefiner</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">)</span>
        <span class="n">refiner</span><span class="o">.</span><span class="n">setJobID</span><span class="p">(</span><span class="n">jobID</span><span class="p">)</span>
        <span class="n">refiner</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        
        <span class="c1"># current data ID</span>
        <span class="n">currentDataID</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">currentDataID</span>
        
        <span class="c1"># add to queue</span>
        <span class="k">for</span> <span class="n">trans</span> <span class="ow">in</span> <span class="n">transList</span><span class="p">:</span>
            <span class="n">jobItem</span> <span class="o">=</span> <span class="n">ClientServerInterface</span><span class="o">.</span><span class="n">JobQueueItem</span><span class="p">(</span><span class="n">ID</span><span class="o">=</span><span class="n">jobID</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">refiner</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> 
                                                         <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">transIniPos</span><span class="p">,</span> <span class="n">transSpecie</span><span class="p">,</span> <span class="n">graphVolume</span><span class="p">),</span>
                                                         <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;reuseWorkVolId&quot;</span><span class="p">:</span> <span class="n">volumeIndex</span><span class="p">,</span> <span class="s2">&quot;volumeTransitionObject&quot;</span><span class="p">:</span> <span class="n">trans</span><span class="p">},</span>
                                                         <span class="n">dataID</span><span class="o">=</span><span class="n">currentDataID</span><span class="p">)</span>
            <span class="n">server</span><span class="o">.</span><span class="n">addJob</span><span class="p">(</span><span class="n">jobItem</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span></div>
    
<div class="viewcode-block" id="KMCRunner.loadTransitionFixFiles"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.loadTransitionFixFiles">[docs]</a>    <span class="k">def</span> <span class="nf">loadTransitionFixFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load fix files</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Loading transition fix files from: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">dirname</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">OWD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>  
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fixFiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.fix*&quot;</span><span class="p">)</span>
            
            <span class="n">volDict</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fixFiles</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Loading fix file: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="n">zipFlag</span><span class="p">,</span> <span class="n">fn2</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">checkForZipped</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn2</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">NSearches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Number of searches: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">NSearches</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    
                    <span class="n">transFixList</span> <span class="o">=</span> <span class="p">[]</span>
                    
                    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">NSearches</span><span class="p">:</span>
                        <span class="c1"># step size</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">stepSize</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        
                        <span class="c1"># displacement vector</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">dispVec</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
                        <span class="n">dispVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dispVec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                        
                        <span class="c1"># dimer orientation vector</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">NVec</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
                        <span class="n">NVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">NVec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                        
                        <span class="c1"># lanczos initial vector</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">rVec</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
                        <span class="n">rVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rVec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                        
                        <span class="c1"># create object</span>
                        <span class="n">obj</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">TransitionFix</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">stepSize</span><span class="p">,</span> <span class="n">dispVec</span><span class="p">,</span> <span class="n">NVec</span><span class="p">,</span> <span class="n">rVec</span><span class="p">)</span>
                        
                        <span class="n">transFixList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                
                <span class="c1"># remove unzipped</span>
                <span class="k">if</span> <span class="n">zipFlag</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">fn2</span><span class="p">)</span>
                
                <span class="c1"># put in vol dict</span>
                <span class="n">volKey</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">volDict</span><span class="p">[</span><span class="n">volKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">transFixList</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">OWD</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">volDict</span></div>
    
<div class="viewcode-block" id="KMCRunner.getTransitions"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.getTransitions">[docs]</a>    <span class="k">def</span> <span class="nf">getTransitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get trans new.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Finding transitions&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># local refs</span>
        <span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        
        <span class="c1"># store full defect list</span>
        <span class="n">fullDefectList</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectList</span>
        
        <span class="c1"># print info about volumes</span>
<span class="c1">#         log(__name__, &quot;Volume info:&quot;, 2)</span>
<span class="c1">#         for i, key in enumerate(currentState.defectVolumesKeys):</span>
<span class="c1">#             log(__name__, </span>
<span class="c1">#                 &quot;Vol %d (%s): ini %d; graph %d; move %d&quot; % (i, key, len(currentState.searchInitialVols[i]), len(currentState.graphVols[i]), </span>
<span class="c1">#                                                             len(currentState.searchMoveVols[i])),2,1)</span>
<span class="c1">#             print &quot;GraphList: &quot;, currentState.graphVols[i]</span>

        <span class="c1"># counter for number of volumes in each each volume group</span>
        <span class="n">volGroupCounter</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">volumeGroupID</span><span class="p">)</span>
        
        <span class="c1"># do we store transitions (if searching) for each volume</span>
        <span class="n">storeTransIfSearching</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">volumeIndex</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span><span class="o">.</span><span class="n">combinedVol</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">reuseCombinedVolumes</span><span class="p">:</span>
                    <span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># is this volume part of a larger group?</span>
                <span class="n">groupID</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">volumeGroupID</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span>
                <span class="n">numInGroup</span> <span class="o">=</span> <span class="n">volGroupCounter</span><span class="p">[</span><span class="n">groupID</span><span class="p">]</span>
                
                <span class="c1"># if it is don&#39;t store transitions</span>
                <span class="k">if</span> <span class="n">numInGroup</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">combinedVolStoreIndividual</span><span class="p">:</span>
                    <span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        
<span class="c1">#         print &quot;STORE TRANS IF SEARCHING&quot;, storeTransIfSearching</span>
        
        <span class="c1"># job IDs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        
        
        <span class="c1"># what to do with vols</span>
        <span class="n">defectVolumesSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">currentVolsSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">)</span>
        <span class="n">searchList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reuseList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">iniEVList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reuseListFull</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reuseDepDict</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># volumes that still need to search</span>
        <span class="n">extraReuse</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tmpDV</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">tmpDV</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">currentVolsSet</span> <span class="ow">and</span> <span class="n">dv</span><span class="o">.</span><span class="n">moreSearch</span><span class="p">:</span>
                <span class="n">extraReuse</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">defectVolumesSet</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">extraReuseSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">extraReuse</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="n">ignoreVolKeys</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">barrIgnoreVolKeys</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">volKey</span> <span class="ow">in</span> <span class="n">currentVolsSet</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">volKey</span> <span class="ow">in</span> <span class="n">ignoreVolKeys</span><span class="p">:</span>                
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Vol </span><span class="si">%s</span><span class="s2"> is in ignored volumes list. Skipping searches/reuse.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volKey</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">volKey</span> <span class="ow">in</span> <span class="n">defectVolumesSet</span><span class="p">:</span>
                <span class="c1"># reuse</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">volumeKey</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">volumeKey</span> <span class="o">==</span> <span class="n">volKey</span><span class="p">:</span>
                        <span class="n">statusTmp</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="c1"># no refinement for basin states, we already searched these states. (May refine for all basin states in later version)</span>
                        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinFlag</span><span class="p">:</span>
                            <span class="n">DVnum</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                                <span class="n">DVnum</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">whichDV</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="n">i</span><span class="p">,)</span>
<span class="c1">#                                 if DVnum is not None and not dupFlag:</span>
                                <span class="k">if</span> <span class="n">DVnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">break</span>
                            <span class="k">if</span> <span class="n">DVnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Vol </span><span class="si">%d</span><span class="s2"> [</span><span class="si">%s</span><span class="s2">] is a basin state that have been visited. Skipping reuse.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">volKey</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1">#                                 tmpFlag = 1</span>
                                <span class="n">statusTmp</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">statusTmp</span><span class="p">:</span>
                            <span class="c1"># add jobs for refinement</span>
                            <span class="n">reuseList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="n">reuseListFull</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="n">iniEVList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if kmcNoSearch is zero, skip searches</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">kmcNoSearch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Skip searching on Vol </span><span class="si">%s</span><span class="s2">, since number of search is ZERO.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volKey</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="c1"># list of all volumes with this key</span>
                <span class="n">volIndicesTmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">)</span> <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">volKey</span><span class="p">]</span>
                
                <span class="c1"># rearrange so all storeTrue volumes are first (two passes)</span>
                <span class="n">volIndices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">foundStoreTrue</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">volIndicesTmp</span><span class="p">:</span>
<span class="c1">#                     if storeTransIfSearching[index]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">partOfCombinedVol</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">combinedVolStoreIndividual</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">combinedVol</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">reuseCombinedVolumes</span><span class="p">):</span>
                        <span class="k">pass</span>
                    
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">volIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                        <span class="n">foundStoreTrue</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">volIndicesTmp</span><span class="p">:</span>
<span class="c1">#                     if not storeTransIfSearching[index]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">partOfCombinedVol</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">combinedVolStoreIndividual</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">combinedVol</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">reuseCombinedVolumes</span><span class="p">):</span>
                        <span class="n">volIndices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                
                <span class="c1"># now decide what to do</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">volIndex</span> <span class="ow">in</span> <span class="n">volIndices</span><span class="p">:</span>
                    
                    <span class="c1"># if the DV is belonged to a basin (dup) state, no search on it</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinFlag</span><span class="p">:</span>
                        <span class="n">DVnum</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                            <span class="n">DVnum</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">whichDV</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="n">volIndex</span><span class="p">,)</span>
    <span class="c1">#                         if DVnum is not None and dupFlag:</span>
                            <span class="k">if</span> <span class="n">DVnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="n">DVnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Vol </span><span class="si">%d</span><span class="s2"> [</span><span class="si">%s</span><span class="s2">] is a (dup) basin state that have been visited. Skipping search.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">volIndex</span><span class="p">,</span> <span class="n">volKey</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="k">continue</span>
                
                    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># always search the first one</span>
                        <span class="n">searchList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">])</span>
                        
                        <span class="n">iniEVList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                        
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">foundStoreTrue</span><span class="p">:</span>
                            <span class="c1"># if we&#39;re storing (at least) the first one then reuse the rest</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">reuseDepDict</span><span class="p">[</span><span class="n">volKey</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                                <span class="n">reuseListFull</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                                <span class="n">iniEVList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">])</span>
                            
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="n">reuseDepDict</span><span class="p">[</span><span class="n">volKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">volIndex</span><span class="p">,]</span>
                                <span class="n">reuseListFull</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                                <span class="n">iniEVList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">])</span>
                        
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># otherwise search the rest too</span>
                            <span class="n">searchList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                            <span class="n">iniEVList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobIDs</span><span class="p">[</span><span class="n">volIndex</span><span class="p">])</span>
                    
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># return if nothing to do</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">reuseList</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">searchList</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="c1"># better ordering of searches (put first ones that have dependencies, otherwise random...)</span>
        <span class="c1">#TODO: at some point ordering should depend on size?</span>
        <span class="n">searchListOrdered</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">volIndex</span> <span class="ow">in</span> <span class="n">searchList</span><span class="p">:</span>
            <span class="n">volKey</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">[</span><span class="n">volIndex</span><span class="p">]</span>
             
            <span class="c1"># if other volumes depend on this volume, put it first</span>
            <span class="k">if</span> <span class="n">volKey</span> <span class="ow">in</span> <span class="n">reuseDepDict</span><span class="p">:</span>
                <span class="n">searchListOrdered</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">volIndex</span><span class="p">)</span>
            <span class="c1"># otherwise just append</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">searchListOrdered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volIndex</span><span class="p">)</span>
         
        <span class="n">searchList</span> <span class="o">=</span> <span class="n">searchListOrdered</span>
        
        <span class="c1"># put combined vols first (debugging)</span>
<span class="c1">#         searchListOrdered = []</span>
<span class="c1">#         for volIndex in searchList:</span>
<span class="c1">#             volKey = currentState.defectVolumesKeys[volIndex]</span>
<span class="c1">#               </span>
<span class="c1">#             # if other volumes depend on this volume, put it first</span>
<span class="c1">#             if currentState.defectVolumes[volIndex].combinedVol:</span>
<span class="c1">#                 searchListOrdered.insert(0, volIndex)</span>
<span class="c1">#             # otherwise just append</span>
<span class="c1">#             else:</span>
<span class="c1">#                 searchListOrdered.append(volIndex)</span>
<span class="c1">#           </span>
<span class="c1">#         searchList = searchListOrdered</span>
        
        <span class="c1"># external events</span>
        <span class="n">externalList</span> <span class="o">=</span> <span class="p">[]</span>
        
<span class="c1">#        print &quot;SEARCH LIST:&quot;, searchList</span>
<span class="c1">#        print &quot;REUSE LIST:&quot;, reuseList</span>
<span class="c1">#        print &quot;REUSE DEP DICT:&quot;, reuseDepDict</span>
<span class="c1">#        print &quot;COMBINED LIST&quot;, combinedList</span>
<span class="c1">#        print &quot;EXTERNAL EVENT LIST&quot;, externalList</span>
<span class="c1">#        print &quot;JOB IDS&quot;, self.jobIDs</span>
        
        <span class="c1"># server set data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;initialState&#39;</span><span class="p">:</span> <span class="n">currentState</span><span class="p">,</span> <span class="s1">&#39;refState&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">refState</span><span class="p">}</span>

        <span class="n">server</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">fixedPrefactor</span><span class="p">:</span>
        <span class="c1"># job ID for eigenvql cqlcs</span>
            <span class="n">eigValJobID</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eigValJobID</span><span class="p">)</span>
            
        <span class="c1"># server set job ids</span>
        <span class="n">server</span><span class="o">.</span><span class="n">setJobIDs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobIDsSet</span><span class="p">)</span>
        
        <span class="c1">#TODO: check that null jobs aren&#39;t added!</span>
        
        <span class="c1"># status object</span>
        <span class="n">statusObj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span>
        <span class="n">statusObj</span><span class="o">.</span><span class="n">resetSearches</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">currentState</span><span class="o">=</span><span class="n">currentState</span><span class="p">)</span>
        <span class="n">statusObj</span><span class="o">.</span><span class="n">updateSearchInfo</span><span class="p">(</span><span class="n">searchList</span><span class="o">=</span><span class="n">searchList</span><span class="p">,</span> <span class="n">reuseList</span><span class="o">=</span><span class="n">reuseListFull</span><span class="p">)</span>
        
        <span class="c1"># check if fixing dimer input</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;fix.input.dir&quot;</span><span class="p">):</span>
            <span class="n">fixSearchDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadTransitionFixFiles</span><span class="p">(</span><span class="s2">&quot;fix.input.dir&quot;</span><span class="p">)</span>
            
            <span class="c1"># do some checks</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixSearchDict</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fixSearchDict</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># dict for storing transition object</span>
        <span class="n">transObjDict</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># add deposition</span>
        
        <span class="c1"># add initial state eigenvalues</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">fixedPrefactor</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addIniEigenValCalcs</span><span class="p">(</span><span class="n">eigValJobID</span><span class="p">,</span> <span class="n">iniEVList</span><span class="p">)</span>
                
        <span class="c1"># add reuse</span>
        <span class="k">for</span> <span class="n">volumeIndex</span> <span class="ow">in</span> <span class="n">reuseList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addRefinement</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">)</span>
         
        <span class="c1"># add searches to server</span>
        <span class="k">for</span> <span class="n">volumeIndex</span> <span class="ow">in</span> <span class="n">searchList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addSearches</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">storeTransIfSearching</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">,</span> <span class="n">fixSearchDict</span><span class="o">=</span><span class="n">fixSearchDict</span><span class="p">)</span>
        
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Waiting for results&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Max idle time: </span><span class="si">%.1f</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">maxIdleTime</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># get results</span>
        <span class="n">lastStatusUpdate</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">lastResultTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">statusUpdateInterval</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">statusUpdateInterval</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># get result (timeout of 10 seconds)</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">empty</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">getResult</span><span class="p">()</span>
            
            <span class="c1"># check if result or timeout</span>
            <span class="k">if</span> <span class="n">empty</span> <span class="ow">or</span> <span class="p">(</span><span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;EMPTYJOB&quot;</span><span class="p">):</span>
                <span class="c1"># if timeout we check how long since the last result was received</span>
                <span class="n">timeSinceLastResult</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">lastResultTime</span>
                
                <span class="c1"># if time since last result if big we should terminate with an error message for now</span>
                <span class="k">if</span> <span class="n">timeSinceLastResult</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">maxIdleTime</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;CRITICAL ERROR: we have not received a result for more than </span><span class="si">%.1f</span><span class="s2"> seconds&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">maxIdleTime</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">server</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">88</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># store time we received this result</span>
                <span class="n">lastResultTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">tmp1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">])</span>
                
                <span class="c1"># process the result</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">processResult</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                
                <span class="n">tmp2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">])</span>
                
                <span class="c1"># if low barrier, build reverse transition</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">tmp2</span><span class="o">-</span><span class="n">tmp1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Prefactor</span><span class="o">.</span><span class="n">iniEVCalcjobName</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">useBasin</span> <span class="ow">and</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">volNum</span> <span class="o">=</span> <span class="n">stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">buildReverseTrans</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">extraReuse</span><span class="p">,</span> <span class="n">volNum</span><span class="p">)</span>
                        <span class="n">extraReuseSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">extraReuse</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">volNum</span> <span class="o">=</span> <span class="n">stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                
                <span class="c1"># if we have been told to stop this job</span>
                <span class="k">if</span> <span class="n">stop</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">volNum</span> <span class="o">=</span> <span class="n">stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    
                    <span class="c1"># do we really need to stop this volume</span>
                    <span class="n">needToStop</span> <span class="o">=</span> <span class="kc">True</span>
                    
                    <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">repeat</span><span class="p">[</span><span class="n">volNum</span><span class="p">]:</span>
                        <span class="c1"># add reuse to dict?</span>
                        <span class="k">if</span> <span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volNum</span><span class="p">]:</span>
                            <span class="n">graphKey</span> <span class="o">=</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span>
                            <span class="n">volTransObject</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">volumeTransitionsDict</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span>
                            
                            <span class="c1"># skip if already stored</span>
                            <span class="k">if</span> <span class="n">graphKey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">:</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning: volume already stored: this will result in undefined behavior!!!&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">graphKey</span> <span class="ow">in</span> <span class="n">extraReuseSet</span><span class="p">:</span>
                                    <span class="n">mergeNum</span> <span class="o">=</span> <span class="n">volTransObject</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">extraReuse</span><span class="p">[</span><span class="n">graphKey</span><span class="p">])</span>
                                    <span class="n">extraReuse</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">graphKey</span><span class="p">)</span>
                                    <span class="n">extraReuseSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">extraReuse</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                                    <span class="k">if</span> <span class="n">mergeNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                        <span class="n">volNum2</span> <span class="o">=</span> <span class="p">[]</span>
                                        <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">)):</span>
                                            <span class="k">if</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">==</span> <span class="n">graphKey</span><span class="p">:</span>
                                                <span class="n">volNum2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
                                        <span class="n">results</span><span class="o">.</span><span class="n">addMergeResultToDict</span><span class="p">(</span><span class="n">mergeNum</span><span class="p">,</span> <span class="n">volTransObject</span><span class="p">,</span> <span class="n">volNum2</span><span class="p">)</span>
                                
                                
                                <span class="n">NSaved</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">volumeTransitionsDict</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)</span>
                                <span class="n">checkRate</span> <span class="o">=</span> <span class="kc">True</span>
                                
                                <span class="c1"># if not enough transitions found, do another set of transitions</span>
                                <span class="k">if</span> <span class="n">NSaved</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">refineMinTransSavedForStorage</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">volTransObject</span><span class="o">.</span><span class="n">searchDone</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Not enough transitions (</span><span class="si">%d</span><span class="s2">&lt;</span><span class="si">%d</span><span class="s2">) found during searches, do more searches&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NSaved</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">refineMinTransSavedForStorage</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                        
                                        <span class="c1"># add searches again</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">addSearches</span><span class="p">(</span><span class="n">volNum</span><span class="p">,</span> <span class="n">storeTransIfSearching</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">,</span> <span class="n">fixSearchDict</span><span class="o">=</span><span class="n">fixSearchDict</span><span class="p">,</span> <span class="n">volTransObject</span><span class="o">=</span><span class="n">volTransObject</span><span class="p">)</span>
                                        <span class="n">volTransObject</span><span class="o">.</span><span class="n">searchDone</span> <span class="o">+=</span> <span class="mi">1</span>
                                        
                                        <span class="n">checkRate</span> <span class="o">=</span> <span class="kc">False</span>
                                        <span class="n">needToStop</span> <span class="o">=</span> <span class="kc">False</span>
                                    
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning!: We have done 2 sets of searches, and still don&#39;t get enough transitions (</span><span class="si">%d</span><span class="s2">&lt;</span><span class="si">%d</span><span class="s2">). Probably those are only transitions we can found.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NSaved</span><span class="p">,</span><span class="n">params</span><span class="o">.</span><span class="n">refineMinTransSavedForStorage</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                                
                                <span class="c1"># check if we should be storing these results or not</span>
                                <span class="c1"># also check if other volumes depended on this one finishing</span>
                                <span class="k">if</span> <span class="n">checkRate</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">NStored</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">NSuccessful</span><span class="p">[</span><span class="n">volNum</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">volumeNItemsDict</span><span class="p">[</span><span class="n">volNum</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">refineSuccessFracForStorage</span><span class="p">:</span>
                                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Removing volume from memory due to low success rate (</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">) </span><span class="si">%d</span><span class="s2"> stored.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">NSuccessful</span><span class="p">[</span><span class="n">volNum</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">volumeNItemsDict</span><span class="p">[</span><span class="n">volNum</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">NStored</span><span class="p">[</span><span class="n">volNum</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                                        
                                        <span class="n">transObjDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">volNum</span><span class="p">)</span>
                                        
                                        <span class="c1"># check if something was waiting for this, run searches if was</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">depList</span> <span class="o">=</span> <span class="n">reuseDepDict</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>
                                            
                                            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">depList</span><span class="p">):</span>
                                                <span class="n">volumeIndex</span> <span class="o">=</span> <span class="n">depList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">addSearches</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">storeTransIfSearching</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">,</span> <span class="n">fixSearchDict</span><span class="o">=</span><span class="n">fixSearchDict</span><span class="p">)</span>
                                                
                                                <span class="k">if</span> <span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]:</span>
                                                    <span class="k">break</span>
                                        
                                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                    
                                    <span class="k">elif</span> <span class="n">NSaved</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">(</span><span class="n">NSaved</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">volumeNItemsDict</span><span class="p">[</span><span class="n">volNum</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">refineSavedFracForStorage</span><span class="p">:</span>
                                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Removing volume from memory due to low number saved (</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NSaved</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">volumeNItemsDict</span><span class="p">[</span><span class="n">volNum</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                                        
                                        <span class="n">transObjDict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">volNum</span><span class="p">)</span>
                                        
                                        <span class="c1"># check if something was waiting for this, run searches if was</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">depList</span> <span class="o">=</span> <span class="n">reuseDepDict</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>
                                            
                                            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">depList</span><span class="p">):</span>
                                                <span class="n">volumeIndex</span> <span class="o">=</span> <span class="n">depList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">addSearches</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">storeTransIfSearching</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">,</span> <span class="n">fixSearchDict</span><span class="o">=</span><span class="n">fixSearchDict</span><span class="p">)</span>
                                                
                                                <span class="k">if</span> <span class="n">storeTransIfSearching</span><span class="p">[</span><span class="n">volumeIndex</span><span class="p">]:</span>
                                                    <span class="k">break</span>
                                        
                                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                    
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">volTransObject</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">volumeTransitionsDict</span><span class="p">[</span><span class="n">volNum</span><span class="p">]</span>
                                        
                                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Storing </span><span class="si">%d</span><span class="s2"> transitions for reuse (</span><span class="si">%s</span><span class="s2">) (in memory)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volTransObject</span><span class="o">.</span><span class="n">transitionList</span><span class="p">),</span> <span class="n">graphKey</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">volTransObject</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                        
                                        <span class="c1"># if something depended on this job finishing, add it (ie if BOTH storeTrans is True and in deps dict)</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">depList</span> <span class="o">=</span> <span class="n">reuseDepDict</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>
                                            
                                            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">depList</span><span class="p">):</span>
                                                <span class="n">volumeIndex</span> <span class="o">=</span> <span class="n">depList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">addRefinement</span><span class="p">(</span><span class="n">volumeIndex</span><span class="p">,</span> <span class="n">transObjDict</span><span class="p">)</span>
                                        
                                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                            <span class="k">pass</span>
                        
                        <span class="k">if</span> <span class="n">needToStop</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Stopping repeating job (vol </span><span class="si">%d</span><span class="s2">, ID </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">volNum</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">ID</span><span class="p">[</span><span class="n">volNum</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">server</span><span class="o">.</span><span class="n">stopJob</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">ID</span><span class="p">[</span><span class="n">volNum</span><span class="p">])</span>
                    
                    <span class="k">if</span> <span class="n">needToStop</span><span class="p">:</span>
                        <span class="c1"># tell results object that we have stopped searches on this volume (ie shouldn&#39;t receive more results on it)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">stopVolume</span><span class="p">(</span><span class="n">volNum</span><span class="p">)</span>
                    
                    <span class="n">allFinished</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                            <span class="n">allFinished</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    
                    <span class="k">if</span> <span class="n">allFinished</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;All jobs completed&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">unfinishedRateCalculations</span><span class="p">):</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;We have some unfinished rate calculations&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">finishLeftRateCalculations</span><span class="p">()</span>
                            
                        <span class="k">break</span>
            
            <span class="c1"># update status</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">lastStatusUpdate</span> <span class="o">&gt;</span> <span class="n">statusUpdateInterval</span><span class="p">:</span>
                <span class="n">statusObj</span><span class="o">.</span><span class="n">writeStatus</span><span class="p">()</span>
                <span class="n">lastStatusUpdate</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">flushSTDOUT</span><span class="p">:</span>
                    <span class="c1"># also flush stdout</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        
        <span class="c1"># write modified volume transition objects</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Writing volume transition object files&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">transObjDict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Writing volume transition object file for volume </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> transitions)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="c1"># send to writer</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">noStoreVolumes</span><span class="p">:</span>
                    <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">params</span><span class="o">.</span><span class="n">volumeDirectory</span><span class="p">)</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;WRITE&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">addCommand</span><span class="p">(</span><span class="s2">&quot;write&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.vol&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">hashKey</span><span class="p">,)})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                
                <span class="c1"># set clean</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Not writing volume transition object file for volume </span><span class="si">%d</span><span class="s2"> (no change)&quot;</span> <span class="o">%</span> <span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># debugging server output</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">debugServer</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">debugJobsByRank</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">barrDebugTotalRates</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">rateDebuggingOutput</span><span class="p">()</span>
        
        <span class="c1"># search timing output</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">barrOutputSearchStats</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">searchTimingOutput</span><span class="p">()</span>
        
        <span class="c1"># clear uniqueness checking lists</span>
        <span class="n">server</span><span class="o">.</span><span class="n">clearUniquenessList</span><span class="p">()</span>
        
        <span class="c1"># check in nodes</span>
<span class="c1">#        server.checkInNodes()</span>
        
        <span class="c1"># finalise</span>
        <span class="n">results</span><span class="o">.</span><span class="n">finalise</span><span class="p">()</span>
        <span class="n">server</span><span class="o">.</span><span class="n">zipCombinedFiles</span><span class="p">(</span><span class="s2">&quot;Step</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">writeStatus</span><span class="p">()</span>
        
        <span class="c1"># store final status (should be a parameter)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusObj</span><span class="o">.</span><span class="n">writeStatus</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;FinalStatus.html&quot;</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;Step</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMCStep</span><span class="p">)</span>
        
        <span class="n">currentState</span><span class="o">.</span><span class="n">defectList</span> <span class="o">=</span> <span class="n">fullDefectList</span>
        
<span class="c1">#         log(__name__, &quot;Clearing data&quot;, 1)</span>
        <span class="c1"># clear data</span>
<span class="c1">#         server.clearData()</span>
        
<span class="c1">#         print &quot;DEBUG: SLEEPING A BIT&quot;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="mi">0</span></div>
        
<div class="viewcode-block" id="KMCRunner.readDefectVolumes"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.readDefectVolumes">[docs]</a>    <span class="k">def</span> <span class="nf">readDefectVolumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read in volumes from the defect volumes directory</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">voldir</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">volumeDirectory</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">voldir</span><span class="p">):</span>
            <span class="n">CWD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">voldir</span><span class="p">)</span>
            
            <span class="n">files</span> <span class="o">=</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">findFiles</span><span class="p">(</span><span class="s2">&quot;*.vol&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">fn</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
                
                <span class="n">volumeTransitions</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">VolumeTransitionsObject</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="n">volumeTransitions</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">volumeTransitions</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reuseStats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">CWD</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="KMCRunner.storeBasinResult"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.storeBasinResult">[docs]</a>    <span class="k">def</span> <span class="nf">storeBasinResult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new basin, and store selected transition into it.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        
        <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">belong2Basin</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">volumeNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;basin: </span><span class="si">%d</span><span class="s2"> / </span><span class="si">%d</span><span class="s2"> volume: </span><span class="si">%d</span><span class="s2"> / </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">basinNum</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">),</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;basin: </span><span class="si">%r</span><span class="s2"> / </span><span class="si">%d</span><span class="s2"> volume: </span><span class="si">%r</span><span class="s2"> / None&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">basinNum</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">),</span> <span class="n">volumeNum</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">volumeNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dupFlag</span><span class="p">:</span>
                <span class="n">basin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="n">basin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeNum</span><span class="p">]</span>
                
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">])):</span>
                    
                    <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">createTrans</span><span class="p">(</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reverseBarriers&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> 
                                                     <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalCOM&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;transIndex&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> 
                                                     <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">final</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finals&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalDVIndex&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                                     <span class="n">moment</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalMoment&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">currentVolIndex</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">index</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                        <span class="n">basin</span><span class="o">.</span><span class="n">currentTrans</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">transitions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span></div>
                
        
<div class="viewcode-block" id="KMCRunner.saveResults2Basin"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.saveResults2Basin">[docs]</a>    <span class="k">def</span> <span class="nf">saveResults2Basin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loop over all volumes, store transitions belongs to basin states into existing basins (may create new basin states, but no new basins).</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        
        <span class="n">volumeList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">numList</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">retry</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Storing searches into basin object with FIXED linkage&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">resultVolIndex</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">resultVolIndex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">elif</span> <span class="n">resultVolIndex</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">volumeList</span><span class="p">:</span>
                <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">belong2Basin</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">volumeNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">volumeList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resultVolIndex</span><span class="p">)</span>
                    <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">belong2Basin</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">numList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">])</span>
                    
                    <span class="n">volumeIJ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeNum</span><span class="p">]</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="s2">&quot;Storing searches (</span><span class="si">%s</span><span class="s2">) into basin object (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">volumeList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">basinNum</span><span class="p">,</span><span class="n">volumeNum</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                    
                    <span class="c1">#check duplicate of transitions may apply here, not implement for now</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">volumeIJ</span><span class="o">.</span><span class="n">createTrans</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reverseBarriers&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> 
                                                  <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalCOM&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;transIndex&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> 
                                                  <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="n">final</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finals&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalDVIndex&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                                  <span class="n">moment</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalMoment&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">currentVolIndex</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">removeFromDict</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span> <span class="o">=</span> <span class="n">numList</span><span class="p">[</span><span class="n">volumeList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">resultVolIndex</span><span class="p">)]</span>
                <span class="n">volumeIJ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeNum</span><span class="p">]</span>
                
                <span class="c1">#check duplicate of transitions may apply here, not implement for now</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">volumeIJ</span><span class="o">.</span><span class="n">createTrans</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reverseBarriers&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> 
                                              <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalCOM&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;transIndex&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> 
                                              <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">final</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finals&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalDVIndex&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                                              <span class="n">moment</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalMoment&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">currentVolIndex</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">removeFromDict</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">retry</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">numList</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">numList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numList</span> <span class="o">=</span> <span class="n">numList</span></div>
    
<div class="viewcode-block" id="KMCRunner.belong2Basin"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.belong2Basin">[docs]</a>    <span class="k">def</span> <span class="nf">belong2Basin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">newbasin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return the index of chosen event in basinList</span>
<span class="sd">        add=1: if not belongs to any basin, create one; if belong to exist basin, create new DV</span>
<span class="sd">        mode=1: chosen event initial from basin volume_list</span>
<span class="sd">        mode=2: chosen event initial from transitions&#39; final</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chosenHashkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">chosenCOM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeCOM&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">basinNum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">volumeNum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">transNum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dupFlag</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">chosenHashkey</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span>
        
        <span class="c1"># store defects in current dv</span>
        <span class="c1"># if this trans from previous basin volume</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinNum&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">i</span><span class="o">=</span><span class="n">j</span><span class="o">=</span><span class="n">dupFlag</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">lattice</span> <span class="o">=</span> <span class="n">Dummy</span><span class="o">.</span><span class="n">DummyLatticeBasin</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
            <span class="n">currentVolIndex</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="n">NDefects</span><span class="p">,</span> <span class="n">vacancies</span><span class="p">,</span> <span class="n">interstitials</span><span class="p">,</span> <span class="n">antisites</span><span class="p">,</span> <span class="n">onAntisites</span><span class="p">,</span> <span class="n">defectPos</span> <span class="o">=</span> <span class="n">Basin</span><span class="o">.</span><span class="n">defectInfo</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">currentVolIndex</span><span class="p">)</span>
            
        <span class="c1"># if this trans from current step searches</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lattice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldState</span>
             
            <span class="n">currentVolIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">currentVolIndex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">NDefects</span><span class="p">,</span> <span class="n">vacancies</span><span class="p">,</span> <span class="n">interstitials</span><span class="p">,</span> <span class="n">antisites</span><span class="p">,</span> <span class="n">onAntisites</span><span class="p">,</span> <span class="n">defectPos</span> <span class="o">=</span> <span class="n">Basin</span><span class="o">.</span><span class="n">defectInfo</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">currentVolIndex</span><span class="p">)</span>
                 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;WARNING: </span><span class="si">%s</span><span class="s2"> not found in currentState defectVolumes&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">chosenHashkey</span><span class="p">,),</span> <span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span>
        
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinNum&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">i</span><span class="o">=</span><span class="n">j</span><span class="o">=</span><span class="n">dupFlag</span><span class="o">=</span><span class="kc">None</span>
            <span class="n">basinNum</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">volumeNum</span> <span class="o">=</span> <span class="n">j</span>
            
            <span class="c1"># if basinNum not stored in resultsDict</span>
            <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">volumeNum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                    <span class="n">basinI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">whichDV</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">currentVolIndex</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">volumeNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">basinNum</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">break</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">basinNum</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">volumeNum</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">dupFlag</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">transNum</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
                <span class="n">basinI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                    <span class="n">volumeIJ</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">transNum</span> <span class="o">=</span> <span class="n">volumeIJ</span><span class="o">.</span><span class="n">whichTrans</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">currentVolIndex</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transNum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">basinNum</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="n">volumeNum</span> <span class="o">=</span> <span class="n">j</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>

        
        <span class="k">if</span> <span class="n">add</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">newbasin</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createNewBasin</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                    <span class="n">basinNum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                    <span class="n">volumeNum</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning, something wrong when create a new basin&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">basinNum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">transIJK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeNum</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">transNum</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">currentBasin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span>
                <span class="c1">#create DV from currentState</span>
                <span class="n">lattice</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span>
                <span class="n">currentBasin</span><span class="o">.</span><span class="n">createDV</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">])</span>
                <span class="n">currentDV</span> <span class="o">=</span> <span class="n">currentBasin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                
                <span class="c1">#connectivity and dupInfo stuff</span>
                <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">transNum</span><span class="p">)):</span>
                    <span class="n">transIJK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">basinNum</span><span class="p">]</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">volumeNum</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">transNum</span><span class="p">[</span><span class="n">kk</span><span class="p">]]</span>
                    <span class="n">transIJK</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="n">transIJK</span><span class="o">.</span><span class="n">finalDV</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentBasin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                    
                    <span class="c1"># store final info as volume dup info</span>
                    <span class="k">if</span> <span class="n">transIJK</span><span class="o">.</span><span class="n">finalHashkey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">transIJK</span><span class="o">.</span><span class="n">finalHashkey</span> <span class="o">!=</span> <span class="n">currentDV</span><span class="o">.</span><span class="n">hashkey</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">transIJK</span><span class="o">.</span><span class="n">finalCOM</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">transIJK</span><span class="o">.</span><span class="n">moment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">currentDV</span><span class="o">.</span><span class="n">dupHashkey</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">finalHashkey</span><span class="p">)</span>
                            <span class="n">currentDV</span><span class="o">.</span><span class="n">dupCOM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">finalCOM</span><span class="p">)</span>
                            <span class="n">currentDV</span><span class="o">.</span><span class="n">dupMoment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">moment</span><span class="p">)</span>
                    <span class="c1"># store final&#39;s dup info into volume dup info</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">)):</span>
                                <span class="k">if</span> <span class="n">transIJK</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">!=</span> <span class="n">currentDV</span><span class="o">.</span><span class="n">hashkey</span><span class="p">:</span>
                                    <span class="n">currentDV</span><span class="o">.</span><span class="n">dupHashkey</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">dupHashkey</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span>
                                    <span class="n">currentDV</span><span class="o">.</span><span class="n">dupCOM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">dupCOM</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span>
                                    <span class="n">currentDV</span><span class="o">.</span><span class="n">dupMoment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">dupMoment</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span>
                
                <span class="n">volumeNum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentBasin</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                
        
        <span class="k">return</span> <span class="n">basinNum</span><span class="p">,</span> <span class="n">volumeNum</span><span class="p">,</span> <span class="n">dupFlag</span></div>
    
<div class="viewcode-block" id="KMCRunner.updateRates"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.updateRates">[docs]</a>    <span class="k">def</span> <span class="nf">updateRates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)):</span>
            <span class="n">basinI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1">#calculate mean rate for each basin</span>
            <span class="n">rates</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">meanRate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="s2">&quot;Mean rate calculation failed due to singular matrix&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># there must be sth wrong for this basin. skipp this basin</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="s2">&quot;Skipping basin </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="s2">&quot;Adding mean rates (basin </span><span class="si">%d</span><span class="s2">) back to resultDict&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)):</span>
                <span class="n">volumeIJ</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volumeIJ</span><span class="o">.</span><span class="n">transitions</span><span class="p">)):</span>
                    <span class="n">transIJK</span> <span class="o">=</span> <span class="n">volumeIJ</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    
                    <span class="c1">#add the whole basin results back to the Dict</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barriers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">barrier</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volIndxs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">currentVolIndex</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;prefactors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fixedPrefactorVal</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reverseBarriers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">reverseBarrier</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rates</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">totalRate</span> <span class="o">+=</span> <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;rates&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;timing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;externals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;barrierOrigin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reuseInfo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;debugSadSearch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinFlag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">flag</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volumeIJ</span><span class="o">.</span><span class="n">hashkey</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;transIndex&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">finalAtomPos</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">finalHashkey</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalCOM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">finalCOM</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalMoment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">moment</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeCOM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volumeIJ</span><span class="o">.</span><span class="n">COM</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;basinNum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="kc">False</span><span class="p">])</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalDVIndex&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">finalVolIndex</span><span class="p">)</span></div>
                    
<div class="viewcode-block" id="KMCRunner.verifyBasin"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.verifyBasin">[docs]</a>    <span class="k">def</span> <span class="nf">verifyBasin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#Check the linkage of basin and currentState. Try to fix wrong basin</span>
        <span class="n">lattice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentState</span>
        <span class="n">currentDVList</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">))</span>
        <span class="n">currentBasinList</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">))</span>
        <span class="n">linkage</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">currentBasinList</span><span class="p">:</span>
            <span class="n">basinI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># check valid of currentTrans &amp; currentDV info</span>
            <span class="k">if</span> <span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">basinI</span><span class="o">.</span><span class="n">previousDV</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">basinI</span><span class="o">.</span><span class="n">previousDV</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">):</span>
                        <span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">previousDV</span>
            <span class="k">if</span> <span class="n">basinI</span><span class="o">.</span><span class="n">currentTrans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">basinI</span><span class="o">.</span><span class="n">currentTrans</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">):</span>
                    <span class="n">basinI</span><span class="o">.</span><span class="n">currentTrans</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentDVList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;What&#39;s going on, more basins than DVs!!!&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="k">break</span>
            
            <span class="c1">#case1, trans not selected in the basin</span>
            <span class="k">if</span> <span class="n">basinI</span><span class="o">.</span><span class="n">currentTrans</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">currentDVList</span><span class="p">:</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">dupFlag</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">whichDV</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Basin </span><span class="si">%d</span><span class="s2">: losing linkage, Something wrong here! trying to fix&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">status</span>  <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="kc">None</span>
                    
                <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dupFlag</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Basin </span><span class="si">%d</span><span class="s2">: currentDV (</span><span class="si">%d</span><span class="s2">) linked to a dup state&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Basin </span><span class="si">%d</span><span class="s2">: currentDV might be wrong! (</span><span class="si">%r</span><span class="s2">-&gt;</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span><span class="p">,</span> <span class="n">index</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span> <span class="o">=</span> <span class="n">index</span>
                
                <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">linkage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                    <span class="n">currentDVList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">currentDVList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
            <span class="c1">#case2, trans is selected in the basin</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">currentDVList</span><span class="p">:</span>
                    <span class="n">transNum</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">whichTrans</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transNum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transNum</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Basin </span><span class="si">%r</span><span class="s2"> Volume </span><span class="si">%r</span><span class="s2"> Trans </span><span class="si">%r</span><span class="s2">: losing linkage, trying to fix&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span><span class="p">,</span> <span class="n">basinI</span><span class="o">.</span><span class="n">currentTrans</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="kc">None</span>
                    
                <span class="k">elif</span> <span class="n">basinI</span><span class="o">.</span><span class="n">currentTrans</span> <span class="ow">in</span> <span class="n">transNum</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Basin </span><span class="si">%r</span><span class="s2"> Volume </span><span class="si">%r</span><span class="s2"> Trans </span><span class="si">%r</span><span class="s2">, linkage goes from other trans </span><span class="si">%r</span><span class="s2">, Trying to fix&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span><span class="p">,</span> <span class="n">basinI</span><span class="o">.</span><span class="n">currentTrans</span><span class="p">,</span> <span class="n">transNum</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="kc">None</span>
                    
                <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">linkage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                    <span class="n">currentDVList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">currentDVList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
        
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Linkage of basinList and currentState: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">linkage</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">linkage</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">linkage</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">linkage</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">basinI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                    <span class="n">volume</span> <span class="o">=</span> <span class="n">basinI</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span><span class="p">]</span>
                    <span class="c1"># manually fix linakge for selected trans</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Manually fix linkage for selected transition (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span><span class="p">,</span><span class="n">basinI</span><span class="o">.</span><span class="n">currentTrans</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">basinI</span><span class="o">.</span><span class="n">currentTrans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentDVList</span><span class="p">):</span>
                        <span class="n">transIJK</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">basinI</span><span class="o">.</span><span class="n">currentTrans</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transIJK</span><span class="p">,</span> <span class="s2">&quot;graphVol&quot;</span><span class="p">):</span>
                            <span class="n">tmp</span><span class="o">=</span><span class="p">[]</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">currentDVList</span><span class="p">:</span>
                                <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Utilities</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">transIJK</span><span class="o">.</span><span class="n">graphVol</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span><span class="p">)))</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">tmp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">j</span> <span class="o">=</span> <span class="n">currentDVList</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="s2">&quot;&gt;&gt;&gt;force link to current volume </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">currentDVList</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                                
                                <span class="n">linkage</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                                <span class="n">currentDVList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">currentDVList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
                                
                                <span class="n">transIJK</span><span class="o">.</span><span class="n">dupHashkey</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span><span class="p">)</span>
                                <span class="n">transIJK</span><span class="o">.</span><span class="n">dupCOM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">)</span>
                                <span class="n">transIJK</span><span class="o">.</span><span class="n">dupMoment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">moment</span><span class="p">)</span>
                                
                                <span class="k">continue</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentDVList</span><span class="p">):</span>
                        <span class="n">tmp</span><span class="o">=</span><span class="p">[]</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">currentDVList</span><span class="p">:</span>
                            <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Utilities</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">graphVol</span><span class="p">,</span> <span class="n">lattice</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span><span class="p">)))</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="n">currentDVList</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">tmp</span><span class="p">))]</span>
                        
                        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="s2">&quot;&gt;&gt;&gt;force basin </span><span class="si">%d</span><span class="s2"> volume </span><span class="si">%d</span><span class="s2"> link to current volume </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">basinI</span><span class="o">.</span><span class="n">currentDV</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">currentDVList</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                            
                            <span class="n">linkage</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                            <span class="n">currentDVList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">currentDVList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
                            
                            <span class="n">volume</span><span class="o">.</span><span class="n">dupHashkey</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">graphKey</span><span class="p">)</span>
                            <span class="n">volume</span><span class="o">.</span><span class="n">dupCOM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">)</span>
                            <span class="n">volume</span><span class="o">.</span><span class="n">dupMoment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lattice</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">moment</span><span class="p">)</span>
                            
                            <span class="k">continue</span>
                    
                    <span class="c1">#for now, we delete the basin...</span>
                    <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Linkage error, for now we delete and reconstruct the basin (</span><span class="si">%d</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ii</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">basinFlag</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span></div>
    
<div class="viewcode-block" id="KMCRunner.createNewBasin"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.createNewBasin">[docs]</a>    <span class="k">def</span> <span class="nf">createNewBasin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">currentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldState</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchResults</span>
        <span class="n">index2</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">Vectors</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeCOM&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">],</span> <span class="n">currentState</span><span class="o">.</span><span class="n">cellDims</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">basinCOMTol</span><span class="p">:</span>
                    <span class="n">index2</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">break</span>
            
        <span class="k">if</span> <span class="n">index2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newBasin</span> <span class="o">=</span> <span class="n">Basin</span><span class="o">.</span><span class="n">BasinObject</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">newBasin</span><span class="o">.</span><span class="n">createDV</span><span class="p">(</span><span class="n">currentState</span><span class="p">,</span> <span class="n">index2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basinList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newBasin</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="mi">1</span></div>
    
<div class="viewcode-block" id="KMCRunner.buildReverseTrans"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.KMCRunner.buildReverseTrans">[docs]</a>    <span class="k">def</span> <span class="nf">buildReverseTrans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">extraReuse</span><span class="p">,</span> <span class="n">volNum</span><span class="p">):</span>
        <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Building reverse transition </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2">) for basin event&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
        
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">graphKey</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;finalHashkey&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">graphKey2</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">graphKey</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s2">&quot;Warning! Final Hashkey is None! Reverse transition not build!&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">currentVolIndex</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">final</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">graphKey</span><span class="p">)</span>
        <span class="n">graphAtoms</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">final</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">currentVolIndex</span><span class="p">]</span><span class="o">.</span><span class="n">graphVol</span>
        
        <span class="n">volTransObj</span> <span class="o">=</span> <span class="n">Defects</span><span class="o">.</span><span class="n">VolumeTransitionsObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">moreSearch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">searchDone</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">volTransObj</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">graphAtoms</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">final</span><span class="p">,</span> <span class="n">graphKey</span><span class="p">)</span>
        <span class="n">volTransObj</span><span class="o">.</span><span class="n">addTransition</span><span class="p">(</span> <span class="n">result</span><span class="o">.</span><span class="n">saddle</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldState</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;reverseBarriers&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hashKey</span><span class="o">=</span><span class="n">graphKey</span><span class="p">,</span> <span class="n">volumeAtoms</span><span class="o">=</span><span class="n">graphAtoms</span><span class="p">)</span>
        <span class="n">volTransObj</span><span class="o">.</span><span class="n">finalHashkey</span> <span class="o">=</span> <span class="n">graphKey2</span>
        
        <span class="c1"># render (searches results) volume transitions, what happens??</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">renderDefectVolumes</span><span class="p">:</span>
            <span class="n">graphKey2</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">resultsDict</span><span class="p">[</span><span class="s2">&quot;volumeHashkey&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vol</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">volumeTransitionsDict</span><span class="p">[</span><span class="n">graphKey2</span><span class="p">]</span>
                <span class="n">tmpLat</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oldState</span><span class="p">)</span>
                <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vol</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">)</span>
                <span class="n">tmpLat</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">specie</span>
                <span class="n">tmpLat</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">initialPos</span>
                <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Rendering</span>
                <span class="n">atomObj</span> <span class="o">=</span> <span class="n">Rendering</span><span class="o">.</span><span class="n">AtomsObject</span><span class="p">()</span>
                <span class="n">atomObj</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">tmpLat</span><span class="p">)</span>
                 
                <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;RENDER&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">atomObj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)Trans&quot;</span><span class="o">%</span><span class="n">graphKey2</span><span class="p">))</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;initial&quot;</span><span class="p">,)</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">item</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                 
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vol</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">checkForFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)Trans&quot;</span><span class="o">%</span><span class="n">graphKey2</span><span class="p">),(</span><span class="s2">&quot;saddle</span><span class="si">%d</span><span class="s2">.png&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))):</span>
                        <span class="k">continue</span>
                    
                    <span class="n">trans</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">transitionList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    
                    <span class="n">tmpLat</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">saddlePos</span>
                    <span class="n">atomObj</span> <span class="o">=</span> <span class="n">Rendering</span><span class="o">.</span><span class="n">AtomsObject</span><span class="p">()</span>
                    <span class="n">atomObj</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">tmpLat</span><span class="p">)</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;RENDER&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">atomObj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)Trans&quot;</span><span class="o">%</span><span class="n">graphKey2</span><span class="p">))</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;saddle</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,)</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                     
                    <span class="n">tmpLat</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">finalPos</span>
                    <span class="n">atomObj</span> <span class="o">=</span> <span class="n">Rendering</span><span class="o">.</span><span class="n">AtomsObject</span><span class="p">()</span>
                    <span class="n">atomObj</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">tmpLat</span><span class="p">)</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;RENDER&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">atomObj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)Trans&quot;</span><span class="o">%</span><span class="n">graphKey2</span><span class="p">))</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;final</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,)</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        
        <span class="c1"># if already stored in extraReuse</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">extraReuse</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>
            <span class="n">tmp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">volTransObj</span><span class="p">)</span>
        <span class="c1"># if not stored</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># try defectVolumes</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">volTransObj</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># DV in currentDV?</span>
                <span class="n">currentVolsSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentState</span><span class="o">.</span><span class="n">defectVolumesKeys</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">graphKey</span> <span class="ow">in</span> <span class="n">currentVolsSet</span><span class="p">:</span>
                    <span class="n">extraReuse</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">volTransObj</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">volTransObj</span>
            
        <span class="c1"># rewrite volume file, send to writer</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">noStoreVolumes</span><span class="p">:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">params</span><span class="o">.</span><span class="n">volumeDirectory</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>
                <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;WRITE&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">],],</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;WRITE&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">extraReuse</span><span class="p">[</span><span class="n">graphKey</span><span class="p">],],</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
            <span class="n">item</span><span class="o">.</span><span class="n">addCommand</span><span class="p">(</span><span class="s2">&quot;write&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.vol&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">graphKey</span><span class="p">,)})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                                    
        
        <span class="c1"># render (reverse) volume transitions, what happens??</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">debugBasin</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">renderDefectVolumes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defectVolumes</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>
                <span class="n">tmpLat</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oldState</span><span class="p">)</span>
                <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vol</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">)</span>
                <span class="n">tmpLat</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">specie</span>
                <span class="n">tmpLat</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">initialPos</span>
                <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Rendering</span>
                <span class="n">atomObj</span> <span class="o">=</span> <span class="n">Rendering</span><span class="o">.</span><span class="n">AtomsObject</span><span class="p">()</span>
                <span class="n">atomObj</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">tmpLat</span><span class="p">)</span>
                
                 
                <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;RENDER&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">atomObj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)Trans&quot;</span><span class="o">%</span><span class="n">graphKey</span><span class="p">))</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;initial&quot;</span><span class="p">,)</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">item</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                 
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vol</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">checkForFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)Trans&quot;</span><span class="o">%</span><span class="n">graphKey</span><span class="p">),(</span><span class="s2">&quot;saddle</span><span class="si">%d</span><span class="s2">.png&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))):</span>
                        <span class="k">continue</span>
                    
                    <span class="n">trans</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">transitionList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    
                    <span class="n">tmpLat</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">saddlePos</span>
                    <span class="n">atomObj</span> <span class="o">=</span> <span class="n">Rendering</span><span class="o">.</span><span class="n">AtomsObject</span><span class="p">()</span>
                    <span class="n">atomObj</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">tmpLat</span><span class="p">)</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;RENDER&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">atomObj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)Trans&quot;</span><span class="o">%</span><span class="n">graphKey</span><span class="p">))</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;saddle</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,)</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    
                    <span class="n">tmpLat</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">finalPos</span>
                    <span class="n">atomObj</span> <span class="o">=</span> <span class="n">Rendering</span><span class="o">.</span><span class="n">AtomsObject</span><span class="p">()</span>
                    <span class="n">atomObj</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">tmpLat</span><span class="p">)</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;RENDER&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">atomObj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)Trans&quot;</span><span class="o">%</span><span class="n">graphKey</span><span class="p">))</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;final</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,)</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vol</span> <span class="o">=</span> <span class="n">extraReuse</span><span class="p">[</span><span class="n">graphKey</span><span class="p">]</span>
                    <span class="n">tmpLat</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oldState</span><span class="p">)</span>
                    <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vol</span><span class="o">.</span><span class="n">NAtomsVolume</span><span class="p">)</span>
                    <span class="n">tmpLat</span><span class="o">.</span><span class="n">specie</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">specie</span>
                    <span class="n">tmpLat</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">initialPos</span>
                    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Rendering</span>
                    <span class="n">atomObj</span> <span class="o">=</span> <span class="n">Rendering</span><span class="o">.</span><span class="n">AtomsObject</span><span class="p">()</span>
                    <span class="n">atomObj</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">tmpLat</span><span class="p">)</span>
                    
                     
                    <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;RENDER&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">atomObj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)Trans&quot;</span><span class="o">%</span><span class="n">graphKey</span><span class="p">))</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;R_initial&quot;</span><span class="p">,)</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                     
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vol</span><span class="o">.</span><span class="n">transitionList</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">Utilities</span><span class="o">.</span><span class="n">checkForFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">outputDirectory</span><span class="p">,(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)Trans&quot;</span><span class="o">%</span><span class="n">graphKey</span><span class="p">),(</span><span class="s2">&quot;R_saddle</span><span class="si">%d</span><span class="s2">.png&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">))):</span>
                            <span class="k">continue</span>
                        
                        <span class="n">trans</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">transitionList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        
                        <span class="n">tmpLat</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">saddlePos</span>
                        <span class="n">atomObj</span> <span class="o">=</span> <span class="n">Rendering</span><span class="o">.</span><span class="n">AtomsObject</span><span class="p">()</span>
                        <span class="n">atomObj</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">tmpLat</span><span class="p">)</span>
                        <span class="n">item</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;RENDER&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">atomObj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)Trans&quot;</span><span class="o">%</span><span class="n">graphKey</span><span class="p">))</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;R_saddle</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,)</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
                        <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        
                        <span class="n">tmpLat</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">finalPos</span>
                        <span class="n">atomObj</span> <span class="o">=</span> <span class="n">Rendering</span><span class="o">.</span><span class="n">AtomsObject</span><span class="p">()</span>
                        <span class="n">atomObj</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">tmpLat</span><span class="p">)</span>
                        <span class="n">item</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">writerItem</span><span class="p">(</span><span class="s2">&quot;RENDER&quot;</span><span class="p">,</span> <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">atomObj</span><span class="p">,],</span> <span class="n">outdir</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)Trans&quot;</span><span class="o">%</span><span class="n">graphKey</span><span class="p">))</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;R_final</span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">i</span><span class="p">,)</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">])</span>
                        <span class="n">writer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span></div></div>

    

<span class="c1">################################################################################ </span>

<div class="viewcode-block" id="runKMCNew"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.runKMCNew">[docs]</a><span class="k">def</span> <span class="nf">runKMCNew</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run new version of KMC.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kmcRunner</span> <span class="o">=</span> <span class="n">KMCRunner</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">kmcRunner</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="commandLineArgs"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.commandLineArgs">[docs]</a><span class="k">def</span> <span class="nf">commandLineArgs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse command line arguments</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run KMC simulation.&quot;</span><span class="p">)</span>
    
<span class="c1">#    parser.add_argument(&#39;inputFile&#39;, help=&quot;The input lattice file.&quot;)</span>
<span class="c1">#    parser.add_argument(&#39;refFile&#39;, help=&quot;The reference lattice file.&quot;)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;paramFile&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;lkmcInput.IN&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;LKMC input file (default=lkmcInput.IN)&quot;</span><span class="p">)</span>
<span class="c1">#    parser.add_argument(&#39;-P&#39;, action=&quot;store_true&quot;, default=False, dest=&quot;profileCode&quot;, help=&quot;Profile the code using the hotshot module (not for production) (default=False)&quot;)</span>
<span class="c1">#    parser.add_argument(&#39;-p&#39;, dest=&quot;statsFile&quot;, default=None, help=&quot;File for dumping profiling stats to (default=None)&quot;)</span>
    
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span></div>

<span class="c1">################################################################################</span>

<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../LKMC/LKMC.KMC.html#LKMC.KMC.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># handle command line args</span>
    <span class="n">progargs</span> <span class="o">=</span> <span class="n">commandLineArgs</span><span class="p">()</span>
    
    <span class="c1"># read the input parameters  </span>
    <span class="n">Input</span><span class="o">.</span><span class="n">readGlobals</span><span class="p">(</span><span class="n">inputFile</span><span class="o">=</span><span class="n">progargs</span><span class="o">.</span><span class="n">paramFile</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">Input</span><span class="o">.</span><span class="n">getLKMCParams</span><span class="p">(</span><span class="n">inputFile</span><span class="o">=</span><span class="n">progargs</span><span class="o">.</span><span class="n">paramFile</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="s2">&quot;launch.dat&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="s2">&quot;launch.dat.gz&quot;</span><span class="p">)))</span>
            <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="s2">&quot;ref.dat&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">,</span> <span class="s2">&quot;ref.dat.gz&quot;</span><span class="p">)))):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: ref.dat and launch.dat must exist in input directory (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="o">.</span><span class="n">inputDirectory</span><span class="p">)</span>
    
    <span class="c1"># run</span>
    <span class="n">kmcRunner</span> <span class="o">=</span> <span class="n">KMCRunner</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kmcRunner</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LKMC 150623-237-g6ff714a documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Chris Scott, Tomas Lazauskas, Miao Yu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.5.
    </div>
  </body>
</html>